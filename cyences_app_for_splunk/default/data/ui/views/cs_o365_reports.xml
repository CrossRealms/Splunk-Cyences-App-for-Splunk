<form theme="dark" stylesheet="cs_o365_reports.css" version="1.1">
  <label>Office 365</label>
  <init>
    <set token="tkn_show_table_authorizationpolicy"></set>
    <set token="tkn_show_table_policy"></set>
    <set token="tkn_show_table_role"></set>
    <set token="tkn_show_table_application"></set>
    <set token="tkn_show_table_group"></set>
    <set token="tkn_show_table_group_membership"></set>
    <set token="tkn_show_table_user"></set>
    <set token="tkn_show_table_serviceprincipal"></set>
    <set token="tkn_show_table_other"></set>
  </init>
  <search>
    <query>| makeresults | eval country=`cs_home_country`</query>
    <earliest>0</earliest>
    <latest>now</latest>
    <sampleRatio>1</sampleRatio>
    <done>
      <set token="tkn_country">$result.country$</set>
    </done>
  </search>
  <fieldset submitButton="false">
    <input type="time" token="timeRange">
      <label>Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="tkn_host">
      <label>Data Collection Host</label>
      <choice value="*">All</choice>
      <default>*</default>
      <fieldForLabel>host</fieldForLabel>
      <fieldForValue>host</fieldForValue>
      <search>
        <query>| tstats count where ((`cs_o365`) OR (`cs_azure_securityscore`) OR (`cs_azure` sourcetype="azure:aad:audit")) by host</query>
        <earliest>-7d@h</earliest>
        <latest>now</latest>
      </search>
      <prefix>host="</prefix>
      <suffix>"</suffix>
    </input>
  </fieldset>
  <row>
    <panel>
      <html>
        <p>Office 365 - Azure</p>
        <p>
          <b>Data Collection:</b> Office 365 management activity data from <a href="https://splunkbase.splunk.com/app/4055/" target="_blank">Splunk Add-on for Office 365</a>.<br/>
          Azure AD data (azure:aad:audit) from <a href="https://splunkbase.splunk.com/app/3757/" target="_blank">Splunk Add on for Microsoft Azure</a>.<br/>
          Microsoft Azure Security Score data from <a href="https://splunkbase.splunk.com/app/5693/" target="_blank">Microsoft Graph Security Score Add-on for Splunk</a>.</p>
      </html>
      <table>
        <search>
          <query>| tstats count where `cs_o365` sourcetype="o365:management:activity" $tkn_host$ 
| eval data=if(count&gt;0, "Data Present", "Data Not Present"), label="`cs_o365` sourcetype=\"o365:management:activity\"" 
| append 
    [| tstats count where `cs_azure` sourcetype="azure:aad:audit"  $tkn_host$ 
    | eval data=if(count&gt;0, "Data Present", "Data Not Present"), label="`cs_azure` sourcetype=\"azure:aad:audit\"" ] 
| append 
    [| tstats count where `cs_azure_securityscore` sourcetype="graphsecurity:score"  $tkn_host$ 
    | eval data=if(count&gt;0, "Data Present", "Data Not Present"), label="`cs_azure_securityscore` sourcetype=\"graphsecurity:score\"" ] 
| table label, data</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="data">
          <colorPalette type="map">{"Data Present": #03991a, "Data Not Present": #a3030b}</colorPalette>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Azure - Current Security Score(In Percentage)</title>
      <single>
        <search>
          <query>`cs_azure_securityscore` sourcetype="graphsecurity:score"  $tkn_host$ | eval percentage = (currentScore/maxScore)*100 | timechart latest(percentage) as percentage | streamstats last(percentage) as percentage</query>
          <earliest>-7d@h</earliest>
          <latest>now</latest>
        </search>
        <option name="numberPrecision">0.0</option>
        <option name="showTrendIndicator">1</option>
        <option name="unit">%</option>
        <option name="drilldown">all</option>
        <drilldown>
          <set token="tkn_panel_basis_security_score_visible">"True"</set>
        </drilldown>
      </single>
      <html>
        <p>DrillDown is present on the panel which will give detailed information of Security Score.</p>
      </html>
    </panel>
    <panel>
      <title>Azure - Current Security Score</title>
      <single>
        <search>
          <query>`cs_azure_securityscore` sourcetype="graphsecurity:score"  $tkn_host$ | head 1 | eval score = currentScore."/".maxScore | fields score</query>
          <earliest>-7d@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="drilldown">all</option>
        <drilldown>
          <set token="tkn_panel_basis_security_score_visible">"True"</set>
        </drilldown>
      </single>
      <html>
        <p>DrillDown is present on the panel which will give detailed information of Security Score.</p>
      </html>
    </panel>
  </row>
  <row depends="$tkn_panel_basis_security_score_visible$">
    <panel>
      <title>Parameter used to calculate Security Score</title>
      <table id="tbl_security_score">
        <search>
          <query>`cs_azure_securityscore` sourcetype="graphsecurity:score" | where $tkn_panel_basis_security_score_visible$=="True"
| head 1
| spath output=controlScores path=controlScores{}  | fields controlScores
| mvexpand controlScores
| spath input=controlScores | table controlCategory controlName controlState State scoreInPercentage count total lastSynced IsEnforced IsEnforced IsApplicable on implementationStatus description | sort  scoreInPercentage, + controlCategory</query>
          <earliest>-7d@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Office 365: Service Status</title>
      <!-- Service Status Reference - https://docs.microsoft.com/en-us/dotnet/api/microsoft.exchange.servicestatus.tenantcommunications.data.servicestatus?view=o365-service-communications -->
      <table id="my_table_with_default_sort">
        <search>
          <query>`cs_o365` (sourcetype="o365:service:healthIssue" OR (sourcetype="o365:service:status" source="*CurrentStatus")) $tkn_host$ 
| eval Status = coalesce(status, Status), Service = coalesce(service, WorkloadDisplayName) 
| stats latest(Status) as Status latest(_time) as _time by Service host 
| rename _time as "LastUpdatedTime" 
| convert ctime(LastUpdatedTime) as LastUpdatedTime 
| table LastUpdatedTime host Service Status 
| sort host Status 
| eval Status_temp=lower(Status) 
| eval Status=case(Status_temp=="serviceinterruption",0,Status_temp=="servicedegradation",1,Status_temp=="restoringservice",2,Status_temp=="extendedrecovery",3,Status_temp=="investigating",4,Status_temp=="servicerestored",5,Status_temp=="falsepositive",6,Status_temp=="postincidentreviewpublished",7,Status_temp=="informationunavailable",8,Status_temp=="serviceoperational",99) 
| fieldformat Status=Status_temp</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <fields>LastUpdatedTime,host,Service,Status</fields>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="Status">
          <colorPalette type="map">{"serviceoperational":#499547,"servicedegradation":#DC4E41,"restoringservice":#F8BE34,"falsepositive":#006D9C,"investigating":#F1813F,"servicerestored":#4FA484,"informationavailable":#E86DD3,"pirpublished":#E86DD3}</colorPalette>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>O365: Activity Over World (Unique Users)</title>
      <map>
        <search>
          <query>`cs_o365` sourcetype="o365:management:activity"  $tkn_host$| iplocation ClientIP | geostats latfield=lat longfield=lon dc(UserId)  by Workload</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="mapping.type">marker</option>
        <option name="refresh.display">progressbar</option>
      </map>
    </panel>
  </row>
  <row>
    <panel>
      <title>Login by Location</title>
      <map>
        <search>
          <query>`cs_o365` sourcetype="o365:management:activity" Workload=AzureActiveDirectory Operation IN("UserLoggedIn", "UserLoginFailed") $tkn_host$ 
| iplocation ClientIP 
| geostats count(UserId) by ResultStatus</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="mapping.type">marker</option>
        <option name="refresh.display">progressbar</option>
        <option name="mapping.fieldColors">{"Success": #008000, "Failed": #ff0000}</option>
        <drilldown>
          <link target="_blank">search?q=%60cs_o365%60%20sourcetype%3D%22o365%3Amanagement%3Aactivity%22%20Workload%3DAzureActiveDirectory%20Operation%20IN(%22UserLoggedIn%22%2C%20%22UserLoginFailed%22)%20$tkn_host$%20%0A%7C%20iplocation%20ClientIP%20%0A%7C%20search%20lat%3E%3D$click.bounds.south$%20lat%3C$click.bounds.north$%20lon%3E%3D$click.bounds.west$%20lon%3C$click.bounds.east$%20%0A%7C%20table%20_time%20ResultStatus%20UserId%20ClientIP%20City%20Region%20Country&amp;earliest=$timeRange.earliest$&amp;latest=$timeRange.latest$</link>
        </drilldown>
      </map>
    </panel>
  </row>
  <row>
    <panel>
      <title>Office 365/Azure - Successful Logins</title>
      <input type="text" token="tkn__user" searchWhenChanged="true">
        <label>User</label>
        <default>*</default>
        <prefix>*</prefix>
        <suffix>*</suffix>
        <initialValue>*</initialValue>
      </input>
      <input type="dropdown" token="tkn_drop__country" searchWhenChanged="true">
        <label>Country</label>
        <selectFirstChoice>true</selectFirstChoice>
        <fieldForLabel>label</fieldForLabel>
        <fieldForValue>value</fieldForValue>
        <search>
          <query>| makeresults count=3 
  | streamstats count 
  | eval label = case(count==2,"All",count==3,"From $tkn_country$",count==1,"Outside of $tkn_country$") 
  | eval value = case(count==2,"*",count==3,"Country=\"$tkn_country$\"",count==1,"Country!=\"$tkn_country$\"")</query>
        </search>
      </input>
      <table>
        <search>
          <query>`cs_o365` sourcetype="o365:management:activity" Workload=AzureActiveDirectory Operation=UserLoggedIn NOT LogonError=* $tkn_host$ 
| fields _time host sourcetype user ClientIP Id user_type authentication_method 
| append 
    [| search `cs_o365` sourcetype=o365:graph:api source="AuditLogs.SignIns" status.errorCode=0 $tkn_host$
    | fields _time host sourcetype userPrincipalName ipAddress id LogonError appDisplayName clientAppUsed conditionalAccessStatus isInteractive status.additionalDetails deviceDetail.* org_country org_region org_city 
    | rename userPrincipalName as user, ipAddress as ClientIP, id as Id, status.additionalDetails as additionalDetails ] 
| eval user = lower(user) 
| stats values(*) as *, max(_time) as Last_Success_Login by Id, host, user, ClientIP 
| search sourcetype="o365:management:activity" 
| fields - Id, sourcetype, lat, lon, deviceDetail.deviceId 
| stats count, values(*) as *, max(Last_Success_Login) as Last_Success_Login by host, user, ClientIP 
| iplocation ClientIP 
| eval Country = if(isnotnull(org_country), org_country, Country) 
| eval Region = if(isnotnull(org_country), org_region, Region) 
| eval City = if(isnotnull(org_country), org_city, City) 
| search $tkn_drop__country$ user=$tkn__user|s$ 
| table user, ClientIP, count, Country, Region, City, Last_Success_Login, user_type, authentication_method, additionalDetails, appDisplayName, clientAppUsed, conditionalAccessStatus, isInteractive, deviceDetail.* 
| `cs_human_readable_time_format(Last_Success_Login)` 
| `cs_o365_success_login_outside_country_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
      <html>
        <p>
          <b>Description:</b> Successful logins that have occurred outside of the specified country. The country can be changed by updating the following macro (Cyences Settings &gt; Cyences App Configuration &gt; Macro Setup &gt; Network): cs_home_country.</p>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Office 365/Azure - Failed Logins</title>
      <input type="text" token="tkn_user" searchWhenChanged="true">
        <label>User</label>
        <default>*</default>
        <prefix>*</prefix>
        <suffix>*</suffix>
        <initialValue>*</initialValue>
      </input>
      <input type="dropdown" token="tkn_drop_country" searchWhenChanged="true">
        <label>Country</label>
        <selectFirstChoice>true</selectFirstChoice>
        <fieldForLabel>label</fieldForLabel>
        <fieldForValue>value</fieldForValue>
        <search>
          <query>| makeresults count=3 
  | streamstats count 
  | eval label = case(count==2,"All",count==3,"From $tkn_country$",count==1,"Outside of $tkn_country$") 
  | eval value = case(count==2,"*",count==3,"Country=\"$tkn_country$\"",count==1,"Country!=\"$tkn_country$\"")</query>
        </search>
      </input>
      <input type="multiselect" token="tkn_logon_error">
        <label>Logon Error</label>
        <choice value="*">All</choice>
        <default>*</default>
        <prefix>LogonError IN (</prefix>
        <suffix>)</suffix>
        <valuePrefix>"</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter>, </delimiter>
        <fieldForLabel>LogonError</fieldForLabel>
        <fieldForValue>LogonError</fieldForValue>
        <search>
          <query>`cs_o365` sourcetype="o365:management:activity" Workload=AzureActiveDirectory Operation=UserLoginFailed $tkn_host$ | dedup LogonError | table LogonError</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
      </input>
      <table>
        <search>
          <query>`cs_o365` sourcetype="o365:management:activity" Workload=AzureActiveDirectory Operation=UserLoginFailed $tkn_host$ $tkn_logon_error$ 
| fields _time host sourcetype user ClientIP Id LogonError user_type authentication_method app ApplicationId ExtendedProperties{}.Name ExtendedProperties{}.Value 
| eval ExtendedProperties=mvzip('ExtendedProperties{}.Name','ExtendedProperties{}.Value'," : ") 
| append 
    [| search `cs_o365` sourcetype=o365:graph:api source="AuditLogs.SignIns" status.errorCode!=0 $tkn_host$ $tkn_logon_error$ 
    | fields _time host sourcetype userPrincipalName ipAddress id LogonError appDisplayName clientAppUsed conditionalAccessStatus isInteractive deviceDetail.* status.* org_country org_region org_city 
    | rename userPrincipalName as user, ipAddress as ClientIP, id as Id, status.failureReason as failureReason, status.additionalDetails as additionalDetails ] 
| eval user = lower(user) 
| stats values(*) as *, max(_time) as _time by Id, host, user, ClientIP, LogonError 
| search sourcetype="o365:management:activity" 
| fields - Id, sourcetype, lat, lon, deviceDetail.deviceId, status.errorCode 
| stats count, values(*) as *, max(_time) as Last_Failed_Login by host, user, ClientIP, LogonError 
| iplocation ClientIP 
| eval Country = if(isnotnull(org_country), org_country, Country) 
| eval Region = if(isnotnull(org_country), org_region, Region) 
| eval City = if(isnotnull(org_country), org_city, City) 
| search $tkn_drop_country$  user=$tkn_user|s$
| table user, ClientIP, LogonError, count, Country, Region, City, Last_Failed_Login, failureReason, additionalDetails, user_type, authentication_method, appDisplayName, clientAppUsed, conditionalAccessStatus, isInteractive, deviceDetail.* , ExtendedProperties
| `cs_human_readable_time_format(Last_Failed_Login)` 
| `cs_o365_failed_login_outside_country_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
      <html>
        <p>
          <b>Description:</b> Failed logins that have occurred outside of the specified country. The country can be changed by updating the following macro (Cyences Settings &gt; Cyences App Configuration &gt; Macro Setup &gt; Network): cs_home_country.</p>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>Office 365/Azure - Login from Unknown UserId</title>
      <table>
        <search>
          <query>`cs_o365` sourcetype="o365:management:activity" Workload=AzureActiveDirectory Operation=UserLoggedIn (UserId=Unknown OR UserId="Not Available") $tkn_host$| iplocation ClientIP | `cs_human_readable_time_format(_time, time)` | stats count, list(time) as time, first(Country) as Country, first(Region) as Region, first(City) as City, first(user) as user by host, ClientIP | fields - time | `cs_o365_login_by_unknown_userid_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
      <html>
        <p>
          <b>Description:</b> Successful logins by an unknown user ID.</p>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>External Users Added to Teams</title>
      <table>
        <search>
          <query>`cs_o365` sourcetype="o365:management:activity" Workload=MicrosoftTeams Operation=MemberAdded Members{}.UPN=*\#ext\#* $tkn_host$
| rename Members{}.UPN AS memberUpn
| eval UserId =lower(UserId)  | rex field=UserId "@(?&lt;src_domain&gt;.*)"
| eval memberUpn =lower(memberUpn)  | rex field=memberUpn "(?&lt;email&gt;.*)\#ext\#" | rex mode=sed field=email "s/_(?!.*_)/@/g" | rex field=email "@(?&lt;target_domain&gt;.*)" 
| where target_domain != src_domain
| stats values(email) as email, values(target_domain) as target_domain, values(ClientIP) as ClientIP by CreationTime, CommunicationType, ItemName, UserId, src_domain 
| fields CreationTime, email, CommunicationType, ItemName, ClientIP, UserId, target_domain
| rename CreationTime AS "Timestamp" ItemName AS "Item Name" UserId AS "Added By" email AS "External User" CommunicationType AS "Added To" target_domain AS "External Domain"</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>O365: Security &amp; Compliance Center: Alert Details</title>
      <table>
        <search>
          <query>`cs_o365` sourcetype=o365:management:activity  Workload=SecurityComplianceCenter Operation=AlertTriggered $tkn_host$
| dedup AlertId
| rex field=Data "\"(?&lt;email&gt;[\w\d\.\-]+\@[\w\d\.]+)\""
| table _time, Severity, Status, email, Name, Comments, Category, AlertType, Data 
| sort -_time</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Azure Active Directory - AuthorizationPolicy Change/Update</title>
      <input type="multiselect" token="tkn_command_authorizationpolicy">
        <label>Command</label>
        <choice value="*">All</choice>
        <default>*</default>
        <initialValue>*</initialValue>
        <fieldForLabel>command</fieldForLabel>
        <fieldForValue>command</fieldForValue>
        <search>
          <query>| inputlookup cs_o365_categories.csv where Category="AuthorizationPolicy"
    | rename Action as command 
    </query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <valuePrefix>"</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter> ,</delimiter>
      </input>
      <input type="text" token="tkn_text_search_authorizationpolicy">
        <label>Text Search</label>
        <default>*</default>
        <initialValue>*</initialValue>
      </input>
      <input type="checkbox" token="tkn_raw_events_authorizationpolicy">
        <label></label>
        <choice value="">Show Raw Events</choice>
        <change>
          <condition match="$tkn_raw_events_authorizationpolicy$==&quot;&quot;">
            <unset token="tkn_show_table_authorizationpolicy"></unset>
          </condition>
          <condition>
            <set token="tkn_show_table_authorizationpolicy"></set>
          </condition>
        </change>
      </input>
      <event depends="$tkn_raw_events_authorizationpolicy$">
        <search>
          <query>`cs_azure_ad_changes("AuthorizationPolicy")` $tkn_host$ $tkn_raw_events_authorizationpolicy$ Command IN ($tkn_command_authorizationpolicy$) $tkn_text_search_authorizationpolicy$ 
| `cs_o365_authorizationpolicy_change_internal_filter` 
| `cs_o365_authorizationpolicy_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="list.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </event>
      <table depends="$tkn_show_table_authorizationpolicy$">
        <search>
          <query>`cs_azure_ad_changes("AuthorizationPolicy")` $tkn_show_table_authorizationpolicy$ Command IN ($tkn_command_authorizationpolicy$) $tkn_text_search_authorizationpolicy$ $tkn_host$ 
| `cs_o365_authorizationpolicy_change_internal_filter`
| eval additional_details = mvzip(key, value, " = ")
| fields _time, Actor, Command, Target_ObjectID, Target_DisplayName, displayName, oldValue, newValue, ResultStatus, modified_properties, additional_details
| azureadmodifiedpropertiesformatter old_value_field=oldValue new_value_field=newValue property_name_field=displayName field_to_update=modified_properties 
| `cs_human_readable_time_format(_time, event_time)`
| table event_time, Actor, Command, Target_ObjectID, Target_DisplayName, ResultStatus, modified_properties, additional_details
| sort 0 - event_time
| `cs_o365_authorizationpolicy_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Azure Active Directory - Policy Change/Update</title>
      <input type="multiselect" token="tkn_command_policy">
        <label>Command</label>
        <choice value="*">All</choice>
        <default>*</default>
        <initialValue>*</initialValue>
        <fieldForLabel>command</fieldForLabel>
        <fieldForValue>command</fieldForValue>
        <search>
          <query>| inputlookup cs_o365_categories.csv where Category="Policy"
    | rename Action as command</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <valuePrefix>"</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter> ,</delimiter>
      </input>
      <input type="text" token="tkn_text_search_policy">
        <label>Text Search</label>
        <default>*</default>
        <initialValue>*</initialValue>
      </input>
      <input type="checkbox" token="tkn_raw_events_policy">
        <label></label>
        <choice value="">Show Raw Events</choice>
        <change>
          <condition match="$tkn_raw_events_policy$==&quot;&quot;">
            <unset token="tkn_show_table_policy"></unset>
          </condition>
          <condition>
            <set token="tkn_show_table_policy"></set>
          </condition>
        </change>
      </input>
      <event depends="$tkn_raw_events_policy$">
        <search>
          <query>`cs_azure_ad_changes("Policy")` $tkn_host$ $tkn_raw_events_policy$ Command IN ($tkn_command_policy$) $tkn_text_search_policy$
| `cs_o365_policy_change_internal_filter` 
| `cs_o365_policy_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="list.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </event>
      <table depends="$tkn_show_table_policy$">
        <search>
          <query>`cs_azure_ad_changes("Policy")` $tkn_host$ $tkn_show_table_policy$ Command IN ($tkn_command_policy$) $tkn_text_search_policy$ 
| `cs_o365_policy_change_internal_filter`
| eval additional_details = mvzip(key, value, " = ") 
| fields _time, Actor, Command, Target_ObjectID, Target_DisplayName, displayName, oldValue, newValue, ResultStatus, modified_properties, additional_details 
| azureadmodifiedpropertiesformatter old_value_field=oldValue new_value_field=newValue property_name_field=displayName field_to_update=modified_properties 
| `cs_human_readable_time_format(_time, event_time)`
| table event_time, Actor, Command, Target_ObjectID, Target_DisplayName, ResultStatus, modified_properties, additional_details
| sort 0 - event_time
| `cs_o365_policy_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Azure Active Directory - Role Change/Update</title>
      <input type="multiselect" token="tkn_command_role">
        <label>Command</label>
        <choice value="*">All</choice>
        <default>*</default>
        <initialValue>*</initialValue>
        <fieldForLabel>command</fieldForLabel>
        <fieldForValue>command</fieldForValue>
        <search>
          <query>| inputlookup cs_o365_categories.csv where Category="Role"
    | rename Action as command</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <valuePrefix>"</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter> ,</delimiter>
      </input>
      <input type="text" token="tkn_text_search_role">
        <label>Text Search</label>
        <default>*</default>
        <initialValue>*</initialValue>
      </input>
      <input type="checkbox" token="tkn_raw_events_role">
        <label></label>
        <choice value="">Show Raw Events</choice>
        <change>
          <condition match="$tkn_raw_events_role$==&quot;&quot;">
            <unset token="tkn_show_table_role"></unset>
          </condition>
          <condition>
            <set token="tkn_show_table_role"></set>
          </condition>
        </change>
      </input>
      <event depends="$tkn_raw_events_role$">
        <search>
          <query>`cs_azure_ad_changes("RoleManagement")` $tkn_host$ Command IN ($tkn_command_role$) $tkn_raw_events_role$ $tkn_text_search_role$
| `cs_o365_role_change_internal_filter` 
| `cs_o365_role_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="list.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </event>
      <table depends="$tkn_show_table_role$">
        <search>
          <query>`cs_azure_ad_changes("RoleManagement")` $tkn_host$ Command IN ($tkn_command_role$) $tkn_show_table_role$ $tkn_text_search_role$ 
| `cs_o365_role_change_internal_filter`
| eval additional_details = mvzip(key, value, " = ")
| fields _time, Actor, Command, Target_ObjectID, Target_DisplayName, displayName, oldValue, newValue, ResultStatus, modified_properties, additional_details
| azureadmodifiedpropertiesformatter old_value_field=oldValue new_value_field=newValue property_name_field=displayName field_to_update=modified_properties
| `cs_human_readable_time_format(_time, event_time)`
| table event_time, Actor, Command, Target_ObjectID, Target_DisplayName, ResultStatus, modified_properties, additional_details
| sort 0 - event_time
| `cs_o365_role_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Azure Active Directory - Group Change/Update</title>
      <input type="multiselect" token="tkn_command_group">
        <label>Command</label>
        <choice value="*">All</choice>
        <default>*</default>
        <initialValue>*</initialValue>
        <fieldForLabel>command</fieldForLabel>
        <fieldForValue>command</fieldForValue>
        <search>
          <query>| inputlookup cs_o365_categories.csv where Category="Group"
    | rename Action as command</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <valuePrefix>"</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter> ,</delimiter>
      </input>
      <input type="text" token="tkn_text_search_group">
        <label>Text Search</label>
        <default>*</default>
        <initialValue>*</initialValue>
      </input>
      <input type="checkbox" token="tkn_raw_events_group">
        <label></label>
        <choice value="">Show Raw Events</choice>
        <change>
          <condition match="$tkn_raw_events_group$==&quot;&quot;">
            <unset token="tkn_show_table_group"></unset>
          </condition>
          <condition>
            <set token="tkn_show_table_group"></set>
          </condition>
        </change>
      </input>
      <event depends="$tkn_raw_events_group$">
        <search>
          <query>`cs_azure_ad_changes("GroupManagement")` `cs_azure_ad_unneccesary_group_change_events` NOT activityDisplayName IN ("Add member to group", "Add owner to group", "Remove member from group", "Remove owner from group") $tkn_host$ Command IN ($tkn_command_group$) $tkn_raw_events_group$ $tkn_text_search_group$
| `cs_o365_group_change_internal_filter` 
| `cs_o365_group_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="list.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </event>
      <table depends="$tkn_show_table_group$">
        <search>
          <query>`cs_azure_ad_changes("GroupManagement")` `cs_azure_ad_unneccesary_group_change_events` NOT activityDisplayName IN ("Add member to group", "Add owner to group", "Remove member from group", "Remove owner from group") $tkn_host$ Command IN ($tkn_command_group$) $tkn_show_table_group$ $tkn_text_search_group$ 
| `cs_o365_group_change_internal_filter`
| eval additional_details = mvzip(key, value, " = ")
| fields _time, Actor, Command, Target_ObjectID, Target_DisplayName, displayName, oldValue, newValue, ResultStatus, modified_properties, additional_details
| azureadmodifiedpropertiesformatter old_value_field=oldValue new_value_field=newValue property_name_field=displayName field_to_update=modified_properties 
| `cs_human_readable_time_format(_time, event_time)`
| table event_time, Actor, Command, Target_ObjectID, Target_DisplayName, ResultStatus, modified_properties, additional_details
| sort 0 - event_time
| `cs_o365_group_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Azure Active Directory - GroupMembership Change/Update</title>
      <input type="multiselect" token="tkn_command_group_membership">
        <label>Command</label>
        <choice value="*">All</choice>
        <default>*</default>
        <initialValue>*</initialValue>
        <fieldForLabel>command</fieldForLabel>
        <fieldForValue>command</fieldForValue>
        <search>
          <query>| inputlookup cs_o365_categories.csv where Category="GroupMembership"
    | rename Action as command</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <valuePrefix>"</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter> ,</delimiter>
      </input>
      <input type="text" token="tkn_text_search_group_membership">
        <label>Text Search</label>
        <default>*</default>
        <initialValue>*</initialValue>
      </input>
      <input type="checkbox" token="tkn_raw_events_group_membership">
        <label></label>
        <choice value="">Show Raw Events</choice>
        <change>
          <condition match="$tkn_raw_events_group_membership$==&quot;&quot;">
            <unset token="tkn_show_table_group_membership"></unset>
          </condition>
          <condition>
            <set token="tkn_show_table_group_membership"></set>
          </condition>
        </change>
      </input>
      <event depends="$tkn_raw_events_group_membership$">
        <search>
          <query>`cs_azure_ad_changes("GroupManagement")` activityDisplayName IN ("Add member to group", "Add owner to group", "Remove member from group", "Remove owner from group") $tkn_host$ Command IN ($tkn_command_group_membership$) $tkn_raw_events_group_membership$ $tkn_text_search_group_membership$
| `cs_o365_group_membership_change_internal_filter` 
| `cs_o365_group_membership_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="list.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </event>
      <table depends="$tkn_show_table_group_membership$">
        <search>
          <query>`cs_azure_ad_changes("GroupManagement")` activityDisplayName IN ("Add member to group", "Add owner to group", "Remove member from group", "Remove owner from group") $tkn_host$ Command IN ($tkn_command_group_membership$) $tkn_show_table_group_membership$ $tkn_text_search_group_membership$ 
| `cs_o365_group_membership_change_internal_filter`
| eval additional_details = mvzip(key, value, " = ")
| fields _time, Actor, Command, Target_ObjectID, Target_DisplayName, displayName, oldValue, newValue, ResultStatus, modified_properties, additional_details
| azureadmodifiedpropertiesformatter old_value_field=oldValue new_value_field=newValue property_name_field=displayName field_to_update=modified_properties
| `cs_human_readable_time_format(_time, event_time)`
| table event_time, Actor, Command, Target_ObjectID, Target_DisplayName, ResultStatus, modified_properties, additional_details
| sort 0 - event_time
| `cs_o365_group_membership_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Azure Active Directory - User Change/Update</title>
      <input type="multiselect" token="tkn_command_user">
        <label>Command</label>
        <choice value="*">All</choice>
        <default>*</default>
        <initialValue>*</initialValue>
        <fieldForLabel>command</fieldForLabel>
        <fieldForValue>command</fieldForValue>
        <search>
          <query>| inputlookup cs_o365_categories.csv where Category="User"
    | rename Action as command</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <valuePrefix>"</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter> ,</delimiter>
      </input>
      <input type="text" token="tkn_text_search_user">
        <label>Text Search</label>
        <default>*</default>
        <initialValue>*</initialValue>
      </input>
      <input type="checkbox" token="tkn_raw_events_user">
        <label></label>
        <choice value="">Show Raw Events</choice>
        <change>
          <condition match="$tkn_raw_events_user$==&quot;&quot;">
            <unset token="tkn_show_table_user"></unset>
          </condition>
          <condition>
            <set token="tkn_show_table_user"></set>
          </condition>
        </change>
      </input>
      <event depends="$tkn_raw_events_user$">
        <search>
          <query>`cs_azure_ad_changes("UserManagement")` $tkn_host$ Command IN ($tkn_command_user$) $tkn_raw_events_user$ $tkn_text_search_user$
| `cs_o365_user_change_internal_filter` 
| `cs_o365_user_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="list.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </event>
      <table depends="$tkn_show_table_user$">
        <search>
          <query>`cs_azure_ad_changes("UserManagement")` $tkn_host$ Command IN ($tkn_command_user$) $tkn_show_table_user$ $tkn_text_search_user$ 
| `cs_o365_user_change_internal_filter` 
| eval additional_details = mvzip(key, value, " = ") 
| fields _time, Actor, Command, Target_ObjectID, Target_DisplayName, displayName, oldValue, newValue, ResultStatus, modified_properties, additional_details 
| azureadmodifiedpropertiesformatter old_value_field=oldValue new_value_field=newValue property_name_field=displayName field_to_update=modified_properties 
| `cs_user_privilege_mapping(Target_DisplayName)` 
| `cs_human_readable_time_format(_time, event_time)`
| table event_time, Actor, Command, Target_ObjectID, Target_DisplayName, ResultStatus, modified_properties, additional_details, is_privileged_user
| sort 0 - event_time
| `cs_o365_user_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Azure Active Directory - ServicePrincipal Change/Update</title>
      <input type="multiselect" token="tkn_command_serviceprincipal">
        <label>Command</label>
        <choice value="*">All</choice>
        <default>*</default>
        <initialValue>*</initialValue>
        <fieldForLabel>command</fieldForLabel>
        <fieldForValue>command</fieldForValue>
        <search>
          <query>| inputlookup cs_o365_categories.csv where Category="ServicePrincipal"
    | rename Action as command</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <valuePrefix>"</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter> ,</delimiter>
      </input>
      <input type="text" token="tkn_text_search_serviceprincipal">
        <label>Text Search</label>
        <default>*</default>
        <initialValue>*</initialValue>
      </input>
      <input type="checkbox" token="tkn_raw_events_serviceprincipal">
        <label></label>
        <choice value="">Show Raw Events</choice>
        <change>
          <condition match="$tkn_raw_events_serviceprincipal$==&quot;&quot;">
            <unset token="tkn_show_table_serviceprincipal"></unset>
          </condition>
          <condition>
            <set token="tkn_show_table_serviceprincipal"></set>
          </condition>
        </change>
      </input>
      <event depends="$tkn_raw_events_serviceprincipal$">
        <search>
          <query>`cs_azure_ad_changes("ApplicationManagement")` activityDisplayName!="*application*" $tkn_host$ Command IN ($tkn_command_serviceprincipal$) $tkn_raw_events_serviceprincipal$ $tkn_text_search_serviceprincipal$ 
| `cs_o365_serviceprincipal_change_internal_filter` 
| `cs_o365_serviceprincipal_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="list.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </event>
      <table depends="$tkn_show_table_serviceprincipal$">
        <search>
          <query>`cs_azure_ad_changes("ApplicationManagement")` activityDisplayName!="*application*" $tkn_host$ Command IN ($tkn_command_serviceprincipal$) $tkn_show_table_serviceprincipal$ $tkn_text_search_serviceprincipal$ 
| `cs_o365_serviceprincipal_change_internal_filter`
| eval additional_details = mvzip(key, value, " = ")
| fields _time, Actor, Command, Target_ObjectID, Target_DisplayName, displayName, oldValue, newValue, ResultStatus, modified_properties, additional_details
| azureadmodifiedpropertiesformatter old_value_field=oldValue new_value_field=newValue property_name_field=displayName field_to_update=modified_properties
| `cs_human_readable_time_format(_time, event_time)`
| table event_time, Actor, Command, Target_ObjectID, Target_DisplayName, ResultStatus, modified_properties, additional_details
| sort 0 - event_time
| `cs_o365_serviceprincipal_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Azure Active Directory - Application Change/Update</title>
      <input type="multiselect" token="tkn_command_application">
        <label>Command</label>
        <choice value="*">All</choice>
        <default>*</default>
        <initialValue>*</initialValue>
        <fieldForLabel>command</fieldForLabel>
        <fieldForValue>command</fieldForValue>
        <search>
          <query>| inputlookup cs_o365_categories.csv where Category="Application"
    | rename Action as command</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <valuePrefix>"</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter> ,</delimiter>
      </input>
      <input type="text" token="tkn_text_search_application">
        <label>Text Search</label>
        <default>*</default>
        <initialValue>*</initialValue>
      </input>
      <input type="checkbox" token="tkn_raw_events_application">
        <label></label>
        <choice value="">Show Raw Events</choice>
        <change>
          <condition match="$tkn_raw_events_application$==&quot;&quot;">
            <unset token="tkn_show_table_application"></unset>
          </condition>
          <condition>
            <set token="tkn_show_table_application"></set>
          </condition>
        </change>
      </input>
      <event depends="$tkn_raw_events_application$">
        <search>
          <query>`cs_azure_ad_changes("ApplicationManagement")` activityDisplayName="*application*" $tkn_host$ Command IN ($tkn_command_application$) $tkn_raw_events_application$ $tkn_text_search_application$
| `cs_o365_application_change_internal_filter` 
| `cs_o365_application_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="list.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </event>
      <table depends="$tkn_show_table_application$">
        <search>
          <query>`cs_azure_ad_changes("ApplicationManagement")` activityDisplayName="*application*" $tkn_host$ Command IN ($tkn_command_application$) $tkn_show_table_application$ $tkn_text_search_application$ 
| `cs_o365_application_change_internal_filter`
| eval additional_details = mvzip(key, value, " = ")
| fields _time, Actor, Command, Target_ObjectID, Target_DisplayName, displayName, oldValue, newValue, ResultStatus, modified_properties, additional_details
| azureadmodifiedpropertiesformatter old_value_field=oldValue new_value_field=newValue property_name_field=displayName field_to_update=modified_properties 
| `cs_human_readable_time_format(_time, event_time)`
| table event_time, Actor, Command, Target_ObjectID, Target_DisplayName, ResultStatus, modified_properties, additional_details
| sort 0 - event_time
| `cs_o365_application_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Azure Active Directory - Other Change/Update</title>
      <input type="multiselect" token="tkn_command_other">
        <label>Command</label>
        <choice value="*">All</choice>
        <default>*</default>
        <initialValue>*</initialValue>
        <fieldForLabel>command</fieldForLabel>
        <fieldForValue>command</fieldForValue>
        <search>
          <query>| inputlookup cs_o365_categories.csv where Category!="Application" Category!="AuthorizationPolicy" Category!="Policy" Category!="Role" Category!="Group" Category!="User" Category!="ServicePrincipal" Category!="GroupMembership" Category!=""
    | rename Action as command</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <valuePrefix>"</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter> ,</delimiter>
      </input>
      <input type="text" token="tkn_text_search_other">
        <label>Text Search</label>
        <default>*</default>
        <initialValue>*</initialValue>
      </input>
      <input type="checkbox" token="tkn_raw_events_other">
        <label></label>
        <choice value="">Show Raw Events</choice>
        <change>
          <condition match="$tkn_raw_events_other$==&quot;&quot;">
            <unset token="tkn_show_table_other"></unset>
          </condition>
          <condition>
            <set token="tkn_show_table_other"></set>
          </condition>
        </change>
      </input>
      <event depends="$tkn_raw_events_other$">
        <search>
          <query>`cs_azure_ad_changes("*")` $tkn_host$ NOT category IN ("AuthorizationPolicy", "Policy", "RoleManagement", "GroupManagement", "UserManagement", "ApplicationManagement") Command IN ($tkn_command_other$) $tkn_raw_events_other$ $tkn_text_search_other$
| `cs_o365_ad_other_change_internal_filter`
| `cs_o365_ad_other_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="list.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </event>
      <table depends="$tkn_show_table_other$">
        <search>
          <query>`cs_azure_ad_changes("*")` $tkn_host$ NOT category IN ("AuthorizationPolicy", "Policy", "RoleManagement", "GroupManagement", "UserManagement", "ApplicationManagement") Command IN ($tkn_command_other$) $tkn_show_table_other$ $tkn_text_search_other$ 
| `cs_o365_ad_other_change_internal_filter`
| eval additional_details = mvzip(key, value, " = ")
| fields _time, Actor, Command, Target_ObjectID, Target_DisplayName, displayName, oldValue, newValue, ResultStatus, modified_properties, additional_details
| azureadmodifiedpropertiesformatter old_value_field=oldValue new_value_field=newValue property_name_field=displayName field_to_update=modified_properties
| `cs_human_readable_time_format(_time, event_time)`
| table event_time, Actor, Command, Target_ObjectID, Target_DisplayName, ResultStatus, modified_properties, additional_details
| sort 0 - event_time
| `cs_o365_ad_other_change_filter`</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>OneDrive or SharePoint File Sharing with External User</title>
      <table>
        <search>
          <query>`cs_o365` sourcetype="o365:management:activity" Workload IN (OneDrive, SharePoint) Operation IN ("SharingSet", "AccessRequestApproved", "SharingRestored", "AnonymousLinkCreated", "SharingInvitationCreated", "SharingInvitationUpdated", "AddedToSecureLink", "SharingPolicyChanged") NOT TargetUserOrGroupType IN ("Member", "SharePointGroup") 
| stats values(Operation) AS Operations, values(EventData) AS EventData, values(ItemType) as ItemType,values(EventSource) as EventSource latest(_time) as LastTime earliest(_time) as FirstTime by SourceFileName, UserId 
| `cs_human_readable_time_format(FirstTime)`
| `cs_human_readable_time_format(LastTime)`
| table UserId,SourceFileName,EventSource,ItemType,Operations,FirstTime,LastTime,EventData</query>
          <earliest>$timeRange.earliest$</earliest>
          <latest>$timeRange.latest$</latest>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
</form>