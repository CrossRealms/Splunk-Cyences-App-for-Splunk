<form theme="dark" version="1.1">
  <label>Globally Detected Malicious IPs</label>
  <search id="search_list">
    <query>| inputlookup cs_malicious_ip_list.csv
| addinfo | where (info_min_time="-Infinity" OR last_seen&gt;=info_min_time) AND (info_max_time="+Infinity" OR last_seen&lt;=info_max_time)
| `cs_human_readable_time_format(last_seen)` 
| table ip, last_seen, ip_location, description  | fillnull value="-" description,ip_location</query>
    <earliest>$tkn_last_seen.earliest$</earliest>
    <latest>$tkn_last_seen.latest$</latest>
  </search>
  <fieldset submitButton="false">
    <input type="time" token="tkn_last_seen">
      <label>Filter by Last Seen Value</label>
      <default>
        <earliest>-7d@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>
  <row>
    <panel>
      <html>
        <p>Globally Detected Malicious IPs</p>
        <p>The Malicious IP List is generated by the "Palo Alto Firewall â€“ Malicious IP List Gen" report and this report relies on the following reports to be enabled</p>
        <p>
          <ul>
            <li>Dynamically Update Blocked IPs with HoneyDB</li>
            <li>Palo Alto Firewall - Network Compromise - Inbound Traffic from Blocked IPs</li>
            <li>Palo Alto Firewall - Network Compromise - Outbound Traffic to Blocked IPs</li>
            <li>Palo Alto Firewall - Network Compromise - DDoS Attack Prevented</li>
          </ul>
        </p>
        <p>The Malicious IP List contains IP addresses discovered in the last seven days by default. The time range can be changed by updating the following macro definition (Settings &gt; Configuration): cs_palo_malicious_ip_list_filter_old_results.</p>
        <p>
          <b>Data Collection:</b> The pan:traffic sourcetype for Palo Alto is being used to collect data via the Palo Alto Networks Add-on for Splunk.</p>
      </html>
      <table>
        <search>
          <query>| rest /servicesNS/-/cyences_app_for_splunk/saved/searches count=0 splunk_server=local | search "eai:acl.app"="cyences_app_for_splunk" title IN ("Dynamically Update Blocked IPs with HoneyDB", "Palo Alto Firewall - Network Compromise - Inbound Traffic from Blocked IPs", "Palo Alto Firewall - Network Compromise - Outbound Traffic to Blocked IPs", "Palo Alto Firewall - Network Compromise - DDoS Attack Prevented", "Palo Alto Firewall - Malicious IP List Gen") | table title, disabled | rename title as label | eval data=if(disabled=1, "Report is disabled", "Report is enabled")
| eval sortnumber=case(label="Dynamically Update Blocked IPs with HoneyDB", 1, label="Palo Alto Firewall - Network Compromise - Inbound Traffic from Blocked IPs", 2, label="Palo Alto Firewall - Network Compromise - Outbound Traffic to Blocked IPs", 3, label="Palo Alto Firewall - Network Compromise - DDoS Attack Prevented", 4, label="Palo Alto Firewall - Malicious IP List Gen", 5)
| sort sortnumber | rename data as report_status
 | table label, report_status</query>
          <earliest>0</earliest>
          <latest></latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="report_status">
          <colorPalette type="map">{"Report is enabled": #03991a, "Report is disabled": #B83C08}</colorPalette>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Malicious IPs on Map</title>
      <map>
        <search base="search_list">
          <query>| eval description=case(description="Incoming traffic into multiple firewalls from this blocked IP", "Incoming Traffic from Blocked IP", description="Outgoing traffic through multiple firewalls to this blocked IP", "Outgoing Traffic to Blocked IP", description="Involved in DDoS Attack", "DDoS", 1==1, "Other")
| iplocation ip | geostats globallimit=0 count by description</query>
        </search>
        <option name="drilldown">all</option>
        <option name="mapping.type">marker</option>
        <drilldown>
          <link target="_blank">search?q=%7C%20inputlookup%20cs_malicious_ip_list.csv%0A%7C%20addinfo%20%7C%20where%20(info_min_time%3D%22-Infinity%22%20OR%20last_seen%3E%3Dinfo_min_time)%20AND%20(info_max_time%3D%22%2BInfinity%22%20OR%20last_seen%3C%3Dinfo_max_time)%0A%7C%20eval%20last_seen%3Dstrftime(last_seen%2C%20%22%25F%20%25T%22)%20%0A%7C%20table%20ip%2C%20last_seen%2C%20ip_location%2C%20description%20%7C%20%20eval%20description%3Dcase(description%3D%22Incoming%20traffic%20into%20multiple%20firewalls%20from%20this%20blocked%20IP%22%2C%20%22Incoming%20Traffic%20from%20Blocked%20IP%22%2C%20description%3D%22Outgoing%20traffic%20through%20multiple%20firewalls%20to%20this%20blocked%20IP%22%2C%20%22Outgoing%20Traffic%20to%20Blocked%20IP%22%2C%20description%3D%22Involved%20in%20DDoS%20Attack%22%2C%20%22DDoS%22%2C%201%3D%3D1%2C%20%22Other%22)%0A%7C%20iplocation%20ip%0A%7C%20search%20lat%3E%3D$click.bounds.south$%20lat%3C$click.bounds.north$%20lon%3E%3D$click.bounds.west$%20lon%3C$click.bounds.east$&amp;earliest=$tkn_last_seen.earliest$&amp;latest=$tkn_last_seen.latest$</link>
        </drilldown>
      </map>
    </panel>
  </row>
  <row>
    <panel>
      <title>Globally Detected Malicious IPs</title>
      <input type="text" token="tkn_ip">
        <label>Search for Bad IP Addresses</label>
        <default>*</default>
        <suffix>*</suffix>
      </input>
      <input type="dropdown" token="tkn_location">
        <label>Search By Location</label>
        <search base="search_list">
          <query> | search ip=$tkn_ip|s$ description=$tkn_description|s$  |stats count by ip_location</query>
        </search>
        <choice value="*">All</choice>
        <default>*</default>
        <initialValue>*</initialValue>
        <fieldForLabel>ip_location</fieldForLabel>
        <fieldForValue>ip_location</fieldForValue>
      </input>
      <input type="dropdown" token="tkn_description">
        <label>Search By Description</label>
        <search base="search_list">
          <query> | search ip=$tkn_ip|s$ ip_location=$tkn_location|s$ |stats count by description</query>
        </search>
        <choice value="*">All</choice>
        <default>*</default>
        <initialValue>*</initialValue>
        <fieldForLabel>description</fieldForLabel>
        <fieldForValue>description</fieldForValue>
      </input>
      <table>
        <search base="search_list">
          <query>| search ip=$tkn_ip|s$ ip_location=$tkn_location|s$ description=$tkn_description|s$</query>
        </search>
        <option name="count">20</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>
</form>
