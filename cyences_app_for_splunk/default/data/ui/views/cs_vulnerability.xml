<form theme="dark" stylesheet="cs_vulnerability.css"  version="1.1">
  <label>Vulnerability</label>
  <search id="vul_summary_search">
    <query>| inputlookup cs_all_vuln where vendor_product="$product$"
| stats count, first(last_scan_time) as last_scan_time, count(eval(status="open" OR status="reopened")) as active, count(eval(status="fixed")) as fixed by dest_id, severity 
| stats first(last_scan_time) as last_scan_time, sum(count) as total_vuln, sum(eval(if(severity="informational", count, 0))) as info_vuln, sum(eval(if(severity="low", count, 0))) as low_vuln, sum(eval(if(severity="medium", count, 0))) as medium_vuln, sum(eval(if(severity="high", count, 0))) as high_vuln, sum(eval(if(severity="critical", count, 0))) as critical_vuln, sum(active) as active_vuln, sum(eval(if(severity="informational", active, 0))) as info_active_vuln, sum(eval(if(severity="low", active, 0))) as low_active_vuln, sum(eval(if(severity="medium", active, 0))) as medium_active_vuln, sum(eval(if(severity="high", active, 0))) as high_active_vuln, sum(eval(if(severity="critical", active, 0))) as critical_active_vuln, sum(fixed) as fixed_vuln, sum(eval(if(severity="informational", fixed, 0))) as info_fixed_vuln, sum(eval(if(severity="low", fixed, 0))) as low_fixed_vuln, sum(eval(if(severity="medium", fixed, 0))) as medium_fixed_vuln, sum(eval(if(severity="high", fixed, 0))) as high_fixed_vuln, sum(eval(if(severity="critical", fixed, 0))) as critical_fixed_vuln by dest_id 
| rename dest_id as asset_id 
| lookup cs_all_assets asset_id OUTPUT asset_ip, asset_hostname, asset_mac_address, os, state 
| eval ip = split(asset_ip, "~~"), hostname = split(asset_hostname, "~~"), mac_address = split(asset_mac_address, "~~") 
| fillnull value="Not Present" ip, hostname, mac_address
| table asset_id, ip, hostname, mac_address, os, total_vuln, fixed_vuln, active_vuln, critical_active_vuln, high_active_vuln, medium_active_vuln, low_active_vuln, info_active_vuln, last_scan_time 
| sort - critical_active_vuln, high_active_vuln</query>
    <earliest>$earliest$</earliest>
    <latest>$latest$</latest>
  </search>
  <search id="vul_list_search">
    <query>| inputlookup cs_all_vuln where vendor_product="$product$" AND dest_id="$asset_id$"
| stats dc(dest_id) as no_of_hosts, first(*) as * by vul_id 
| fillnull value="Not Present" cve, signature
| eval sort_field=case(severity="critical",1, severity="high",2, severity="medium",3, severity="low",4, severity="informational",5, 1=1, 6) 
| `cs_human_readable_time_format(first_found)`
| `cs_human_readable_time_format(last_found)`
| sort sort_field
| table vul_id signature no_of_hosts category type severity status cve cvss cpe protocol port has_patch in_the_news published_time first_found last_found solution description</query>
    <earliest>$earliest$</earliest>
    <latest>$latest$</latest>
  </search>
  <fieldset submitButton="false">
    <input type="dropdown" token="product" searchWhenChanged="true">
      <label>Product</label>
      <fieldForLabel>vendor_product</fieldForLabel>
      <fieldForValue>vendor_product</fieldForValue>
      <selectFirstChoice>true</selectFirstChoice>
      <search>
        <query>| inputlookup cs_all_vuln | fields vendor_product | dedup vendor_product</query>
        <earliest>$earliest$</earliest>
        <latest>$latest$</latest>
      </search>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Unique Vulnerability Count By Severity</title>
      <chart id="severity_count_chart_unique">
        <search>
          <query>| inputlookup cs_all_vuln where vendor_product="$product$" AND (status="open" OR status="reopened")
| dedup vul_id 
| stats count by severity 
| transpose 0 header_field=severity | fields - column | addtotals
| table Total critical high medium low informational</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="charting.fieldColors">{"critical":#D93F3C,"high":#ED8440,"medium":#F7BC38,"low":#65A637,"informational":#6DB7C6}</option>
      </chart>
    </panel>
    <panel>
      <title>New Unique Vulnerability Found Over Time</title>
      <input type="text" token="days_ago_unique" searchWhenChanged="true">
        <label>Days Ago</label>
        <default>7</default>
        <prefix>-</prefix>
        <suffix>d@h</suffix>
      </input>
      <chart>
        <search>
          <query>| inputlookup cs_all_vuln where vendor_product="$product$" AND (status="open" OR status="reopened") 
| dedup vul_id 
| eval _time=first_found 
| eval days_ago_unique=relative_time(now(), "$days_ago_unique$") 
| where _time &gt;= days_ago_unique 
| timechart span=1d count as active</query>
          <earliest>$days_ago_unique$</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>Total Vulnerability Count By Severity</title>
      <chart id="severity_count_chart_total">
        <search>
          <query>| inputlookup cs_all_vuln where vendor_product="$product$" AND (status="open" OR status="reopened")
| dedup vul_id, dest_id
| stats count by severity 
| eval sort_field=case(severity="critical",1, severity="high",2, severity="medium",3, severity="low",4, severity="informational",5, 1=1, 6) 
| sort sort_field 
| fields - sort_field</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>New Total Vulnerability Found Over Time</title>
      <input type="text" token="days_ago_total" searchWhenChanged="true">
        <label>Days Ago</label>
        <default>7</default>
        <prefix>-</prefix>
        <suffix>d@h</suffix>
      </input>
      <chart>
        <search>
          <query>| inputlookup cs_all_vuln where vendor_product="$product$" AND (status="open" OR status="reopened") 
| dedup vul_id, dest_id 
| eval _time=first_found 
| eval days_ago_total=relative_time(now(), "$days_ago_total$") 
| where _time &gt;= days_ago_total 
| timechart span=1d count as active</query>
          <earliest>$days_ago_total$</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <input type="text" token="ip" searchWhenChanged="true">
        <label>ip</label>
        <default>*</default>
      </input>
      <input type="text" token="hostname" searchWhenChanged="true">
        <label>hostname</label>
        <default>*</default>
      </input>
      <input type="text" token="mac_address" searchWhenChanged="true">
        <label>mac_address</label>
        <default>*</default>
      </input>
      <table>
        <search base="vul_summary_search">
          <query>| search ip=$ip$ hostname=$hostname$ mac_address=$mac_address$</query>
        </search>
        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="critical_active_vuln">
          <colorPalette type="list">[#B83C08]</colorPalette>
          <scale type="threshold">1</scale>
        </format>
        <format type="color" field="high_active_vuln">
          <colorPalette type="list">[#d96704]</colorPalette>
          <scale type="threshold">1</scale>
        </format>
        <format type="color" field="medium_active_vuln">
          <colorPalette type="list">[#dbb300]</colorPalette>
          <scale type="threshold">1</scale>
        </format>
        <drilldown>
          <set token="form.asset_id">$row.asset_id$</set>
        </drilldown>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Vulnerabilities</title>
      <input type="text" token="asset_id" searchWhenChanged="true">
        <label>asset_id</label>
        <default>*</default>
      </input>
      <input type="multiselect" token="status" searchWhenChanged="true">
        <label>status</label>
        <choice value="open">open</choice>
        <choice value="reopened">reopened</choice>
        <choice value="fixed">fixed</choice>
        <choice value="*">All</choice>
        <default>open,reopened</default>
        <prefix>(</prefix>
        <suffix>)</suffix>
        <valuePrefix>"</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter>,</delimiter>
      </input>
      <input type="multiselect" token="severity" searchWhenChanged="true">
        <label>severity</label>
        <choice value="critical">critical</choice>
        <choice value="high">high</choice>
        <choice value="medium">medium</choice>
        <choice value="low">low</choice>
        <choice value="informational">informational</choice>
        <choice value="*">ALL</choice>
        <default>critical,high,medium</default>
        <prefix>(</prefix>
        <suffix>)</suffix>
        <valuePrefix>"</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter>,</delimiter>
      </input>
      <input type="text" token="cve" searchWhenChanged="true">
        <label>cve</label>
        <default></default>
      </input>
      <input type="text" token="signature" searchWhenChanged="true">
        <label>signature</label>
        <default></default>
      </input>
      <table>
        <search base="vul_list_search">
          <query>| search status IN $status$ severity IN $severity$ cve="*$cve$*" signature="*$signature$*"</query>
        </search>
        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">false</option>
        <drilldown>
          <set token="vul_id">$row.vul_id$</set>
          <set token="signature2">$row.signature$</set>
        </drilldown>
        <format type="color" field="severity">
          <colorPalette type="map">{"critical":#B83C08, "high": #d96704, "medium" : #dbb300}</colorPalette>
        </format>
        <format type="color" field="status">
          <colorPalette type="map">{"open":#B83C08, "reopened":#B83C08}</colorPalette>
        </format>
      </table>
    </panel>
  </row>
  <row depends="$vul_id$">
    <panel>
      <title>Affected Hosts - $vul_id$ - $signature2$</title>
      <table>
        <search>
          <query>| inputlookup cs_all_vuln where vendor_product="$product$" AND vul_id="$vul_id$"
| rename dest_id as asset_id 
| lookup cs_all_assets asset_id OUTPUT asset_ip, asset_hostname, asset_mac_address, os 
| eval ip = split(asset_ip, "~~"), hostname = split(asset_hostname, "~~"), mac_address = split(asset_mac_address, "~~") 
| table asset_id, ip, hostname, mac_address, os, last_scan_time</query>
          <earliest>$earliest$</earliest>
          <latest>$latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>
</form>
