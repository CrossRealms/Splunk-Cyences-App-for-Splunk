<form theme="dark" version="1.1">
  <label>Vulnerability</label>
  <search id="vul_summary_search">
    <query>| tstats `cs_summariesonly_cyences_vulnerabilities` count, latest(Vulnerabilities.last_scan_time) as last_scan_time, latest(Vulnerabilities.severity) as severity, latest(Vulnerabilities.status) as status FROM datamodel=Cyences_Vulnerabilities where Vulnerabilities.vendor_product="$product$" by Vulnerabilities.dest_id, Vulnerabilities.vul_id 
| `drop_dm_object_name(Vulnerabilities)` 
| stats count, first(last_scan_time) as last_scan_time, count(eval(status="open" OR status="reopened")) as active, count(eval(status="fixed")) as fixed by dest_id, severity 
| stats first(last_scan_time) as last_scan_time, sum(count) as total_vuln, sum(eval(if(severity="informational", count, 0))) as info_vuln, sum(eval(if(severity="low", count, 0))) as low_vuln, sum(eval(if(severity="medium", count, 0))) as medium_vuln, sum(eval(if(severity="high", count, 0))) as high_vuln, sum(eval(if(severity="critical", count, 0))) as critical_vuln, sum(active) as active_vuln, sum(eval(if(severity="informational", active, 0))) as info_active_vuln, sum(eval(if(severity="low", active, 0))) as low_active_vuln, sum(eval(if(severity="medium", active, 0))) as medium_active_vuln, sum(eval(if(severity="high", active, 0))) as high_active_vuln, sum(eval(if(severity="critical", active, 0))) as critical_active_vuln, sum(fixed) as fixed_vuln, sum(eval(if(severity="informational", fixed, 0))) as info_fixed_vuln, sum(eval(if(severity="low", fixed, 0))) as low_fixed_vuln, sum(eval(if(severity="medium", fixed, 0))) as medium_fixed_vuln, sum(eval(if(severity="high", fixed, 0))) as high_fixed_vuln, sum(eval(if(severity="critical", fixed, 0))) as critical_fixed_vuln by dest_id 
| rename dest_id as asset_id 
| lookup cs_all_assets asset_id OUTPUT asset_ip, asset_hostname, asset_mac_address, os, state 
| eval ip = split(asset_ip, "~~"), hostname = split(asset_hostname, "~~"), mac_address = split(asset_mac_address, "~~") 
| fillnull value="Not Present" ip, hostname, mac_address
| table asset_id, ip, hostname, mac_address, os, total_vuln, fixed_vuln, active_vuln, critical_active_vuln, high_active_vuln, fixed_vuln, medium_active_vuln, low_active_vuln, info_active_vuln, last_scan_time 
| sort - active_vuln</query>
    <earliest>$timerange.earliest$</earliest>
    <latest>$timerange.latest$</latest>
  </search>
  <search id="vul_list_search">
    <query>| tstats `cs_summariesonly_cyences_vulnerabilities` count, dc(Vulnerabilities.dest_id) as no_of_hosts, latest(Vulnerabilities.signature) as signature, latest(Vulnerabilities.category) as category, latest(Vulnerabilities.severity) as severity, latest(Vulnerabilities.status) as status, latest(Vulnerabilities.type) as type, latest(Vulnerabilities.cve) as cve, latest(Vulnerabilities.protocol) as protocol, latest(Vulnerabilities.port) as port, latest(Vulnerabilities.first_found) as first_found, latest(Vulnerabilities.last_found) as last_found FROM datamodel=Cyences_Vulnerabilities where Vulnerabilities.vendor_product="$product$" Vulnerabilities.dest_id="$asset_id$" by Vulnerabilities.vul_id 
| `drop_dm_object_name(Vulnerabilities)` 
| fillnull value="Not Present" cve, signature
| eval sort_field=case(severity="critical",1, severity="high",2, severity="medium",3, severity="low",4, severity="informational",5, 1=1, 6) 
| sort sort_field
| table vul_id signature category no_of_hosts severity status cve protocol port first_found last_found</query>
    <earliest>$timerange.earliest$</earliest>
    <latest>$timerange.latest$</latest>
  </search>
  <fieldset submitButton="false">
    <input type="time" token="timerange" searchWhenChanged="true">
      <label></label>
      <default>
        <earliest>-90d@d</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="product" searchWhenChanged="true">
      <label>Product</label>
      <fieldForLabel>vendor_product</fieldForLabel>
      <fieldForValue>vendor_product</fieldForValue>
      <selectFirstChoice>true</selectFirstChoice>
      <search>
        <query>| tstats `cs_summariesonly_cyences_vulnerabilities` count from datamodel=Cyences_Vulnerabilities by Vulnerabilities.vendor_product 
| `drop_dm_object_name(Vulnerabilities)`</query>
        <earliest>$timerange.earliest$</earliest>
        <latest>$timerange.latest$</latest>
      </search>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Vulenerability Count By Severity</title>
      <chart>
        <search>
          <query>| tstats `cs_summariesonly_cyences_vulnerabilities` count, latest(Vulnerabilities.severity) as severity, latest(Vulnerabilities.status) as status FROM datamodel=Cyences_Vulnerabilities where Vulnerabilities.vendor_product="$product$" by Vulnerabilities.vul_id 
| `drop_dm_object_name(Vulnerabilities)` 
| search status IN ("open", "reopened") 
| stats count by severity 
| eval sort_field=case(severity="critical",1, severity="high",2, severity="medium",3, severity="low",4, severity="informational",5, 1=1, 6) 
| sort sort_field 
| fields - sort_field</query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>New Vulnerability Found Over Time</title>
      <input type="text" token="days_ago" searchWhenChanged="true">
        <label>Days Ago</label>
        <default>7</default>
        <prefix>-</prefix>
        <suffix>d@h</suffix>
      </input>
      <chart>
        <search>
          <query>| tstats `cs_summariesonly_cyences_vulnerabilities` count, latest(Vulnerabilities.first_found) as first_found, latest(Vulnerabilities.status) as status FROM datamodel=Cyences_Vulnerabilities where Vulnerabilities.vendor_product="$product$" by Vulnerabilities.vul_id 
| `drop_dm_object_name(Vulnerabilities)` 
| eval _time=strptime('first_found', "%Y-%m-%dT%H:%M:%S.%NZ") 
| eval days_ago=relative_time(now(), "$days_ago$") 
| where _time &gt;= days_ago 
| timechart span=1d count(eval(status="open" OR status="reopened")) as active</query>
          <earliest>$days_ago$</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <input type="text" token="ip" searchWhenChanged="true">
        <label>ip</label>
        <default>*</default>
      </input>
      <input type="text" token="hostname" searchWhenChanged="true">
        <label>hostname</label>
        <default>*</default>
      </input>
      <input type="text" token="mac_address" searchWhenChanged="true">
        <label>mac_address</label>
        <default>*</default>
      </input>
      <table>
        <search base="vul_summary_search">
          <query>| search ip=$ip$ hostname=$hostname$ mac_address=$mac_address$</query>
        </search>
        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="critical_active_vuln">
          <colorPalette type="list">[#a30000]</colorPalette>
          <scale type="threshold">1</scale>
        </format>
        <format type="color" field="high_active_vuln">
          <colorPalette type="list">[#e87000]</colorPalette>
          <scale type="threshold">1</scale>
        </format>
        <drilldown>
          <set token="form.asset_id">$row.asset_id$</set>
        </drilldown>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Vulnerabilities</title>
      <input type="text" token="asset_id" searchWhenChanged="true">
        <label>asset_id</label>
        <default>*</default>
      </input>
      <input type="multiselect" token="status" searchWhenChanged="true">
        <label>status</label>
        <choice value="open">open</choice>
        <choice value="reopened">reopened</choice>
        <choice value="fixed">fixed</choice>
        <choice value="*">All</choice>
        <default>open,reopened</default>
        <prefix>(</prefix>
        <suffix>)</suffix>
        <valuePrefix>"</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter>,</delimiter>
      </input>
      <input type="multiselect" token="severity" searchWhenChanged="true">
        <label>severity</label>
        <choice value="critical">critical</choice>
        <choice value="high">high</choice>
        <choice value="medium">medium</choice>
        <choice value="low">low</choice>
        <choice value="informational">informational</choice>
        <choice value="*">ALL</choice>
        <default>critical,high,medium</default>
        <prefix>(</prefix>
        <suffix>)</suffix>
        <valuePrefix>"</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter>,</delimiter>
      </input>
      <input type="text" token="cve" searchWhenChanged="true">
        <label>cve</label>
        <default></default>
      </input>
      <input type="text" token="signature" searchWhenChanged="true">
        <label>signature</label>
        <default></default>
      </input>
      <table>
        <search base="vul_list_search">
          <query>| search status IN $status$ severity IN $severity$ cve="*$cve$*" signature="*$signature$*"</query>
        </search>
        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
        <drilldown>
          <set token="vul_id">$row.vul_id$</set>
          <set token="signature2">$row.signature$</set>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$vul_id$">
    <panel>
      <title>Affected Hosts - $vul_id$ - $signature2$</title>
      <table>
        <search>
          <query>| tstats `cs_summariesonly_cyences_vulnerabilities` count, latest(Vulnerabilities.last_scan_time) as last_scan_time FROM datamodel=Cyences_Vulnerabilities where Vulnerabilities.vul_id="$vul_id$" Vulnerabilities.vendor_product="$product$" by Vulnerabilities.dest_id 
| `drop_dm_object_name(Vulnerabilities)` 
| rename dest_id as asset_id 
| lookup cs_all_assets asset_id OUTPUT asset_ip, asset_hostname, asset_mac_address, os 
| eval ip = split(asset_ip, "~~"), hostname = split(asset_hostname, "~~"), mac_address = split(asset_mac_address, "~~") 
| table asset_id, ip, hostname, mac_address, os, last_scan_time</query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>
</form>