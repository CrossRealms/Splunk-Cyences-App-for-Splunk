<form theme="dark" version="1.1">
  <label>Vulnerability</label>
  <search id="vul_summary_search">
    <query>| tstats `cs_summariesonly_cyences_vulnerabilities` count, first(Vulnerabilities.last_scan_time) as last_scan_time, first(Vulnerabilities.severity) as severity, first(Vulnerabilities.status) as status FROM datamodel=Cyences_Vulnerabilities where Vulnerabilities.vendor_product="$product$" by Vulnerabilities.dest_id, Vulnerabilities.vul_id 
| `drop_dm_object_name(Vulnerabilities)` 
| stats count, first(last_scan_time) as last_scan_time, count(eval(status="open" OR status="reopened")) as active, count(eval(status="fixed")) as fixed by dest_id, severity 
| stats first(last_scan_time) as last_scan_time, sum(count) as total_vuln, sum(eval(if(severity="informational", count, 0))) as info_vuln, sum(eval(if(severity="low", count, 0))) as low_vuln, sum(eval(if(severity="medium", count, 0))) as medium_vuln, sum(eval(if(severity="high", count, 0))) as high_vuln, sum(eval(if(severity="critical", count, 0))) as critical_vuln, sum(active) as active_vuln, sum(eval(if(severity="informational", active, 0))) as info_active_vuln, sum(eval(if(severity="low", active, 0))) as low_active_vuln, sum(eval(if(severity="medium", active, 0))) as medium_active_vuln, sum(eval(if(severity="high", active, 0))) as high_active_vuln, sum(eval(if(severity="critical", active, 0))) as critical_active_vuln, sum(fixed) as fixed_vuln, sum(eval(if(severity="informational", fixed, 0))) as info_fixed_vuln, sum(eval(if(severity="low", fixed, 0))) as low_fixed_vuln, sum(eval(if(severity="medium", fixed, 0))) as medium_fixed_vuln, sum(eval(if(severity="high", fixed, 0))) as high_fixed_vuln, sum(eval(if(severity="critical", fixed, 0))) as critical_fixed_vuln by dest_id 
| rename dest_id as asset_id 
| lookup cs_all_assets asset_id OUTPUT asset_ip, asset_hostname, asset_mac_address, os, state 
| eval ip = split(asset_ip, "~~"), hostname = split(asset_hostname, "~~"), mac_address = split(asset_mac_address, "~~") 
| fillnull value="Not Present" ip, hostname, mac_address
| table asset_id, ip, hostname, mac_address, os, total_vuln, fixed_vuln, active_vuln, critical_active_vuln, high_active_vuln, fixed_vuln, medium_active_vuln, low_active_vuln, info_active_vuln, last_scan_time 
| sort - active_vuln</query>
    <earliest>$timerange.earliest$</earliest>
    <latest>$timerange.latest$</latest>
  </search>
  <search id="vul_list_search">
    <query>| tstats `cs_summariesonly_cyences_vulnerabilities` count, first(Vulnerabilities.signature) as signature, first(Vulnerabilities.category) as category, first(Vulnerabilities.severity) as severity, first(Vulnerabilities.status) as status, first(Vulnerabilities.type) as type, first(Vulnerabilities.cve) as cve, first(Vulnerabilities.protocol) as protocol, first(Vulnerabilities.port) as port FROM datamodel=Cyences_Vulnerabilities where Vulnerabilities.vendor_product="$product$" Vulnerabilities.dest_id="$asset_id$" by Vulnerabilities.dest_id, Vulnerabilities.vul_id 
| `drop_dm_object_name(Vulnerabilities)` 
| eval sort_field=case(severity="critical",1, severity="high",2, severity="medium",3, severity="low",4, severity="informational",5, 1=1, 6) 
| sort sort_field
| table vul_id signature category severity status cve protocol port</query>
    <earliest>$timerange.earliest$</earliest>
    <latest>$timerange.latest$</latest>
  </search>
  <fieldset submitButton="false">
    <input type="time" token="timerange" searchWhenChanged="true">
      <label></label>
      <default>
        <earliest>-7d@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="product" searchWhenChanged="true">
      <label>Product</label>
      <fieldForLabel>vendor_product</fieldForLabel>
      <fieldForValue>vendor_product</fieldForValue>
      <selectFirstChoice>true</selectFirstChoice>
      <search>
        <query>| tstats count from datamodel=Cyences_Vulnerabilities by Vulnerabilities.vendor_product 
| `drop_dm_object_name(Vulnerabilities)`</query>
        <earliest>-7d@h</earliest>
        <latest>now</latest>
      </search>
    </input>
  </fieldset>
  <row>
    <panel>
      <input type="text" token="ip" searchWhenChanged="true">
        <label>ip</label>
        <default>*</default>
      </input>
      <input type="text" token="hostname" searchWhenChanged="true">
        <label>hostname</label>
        <default>*</default>
      </input>
      <input type="text" token="mac_address" searchWhenChanged="true">
        <label>mac_address</label>
        <default>*</default>
      </input>
      <table>
        <search base="vul_summary_search">
          <query>| search ip=$ip$ hostname=$hostname$ mac_address=$mac_address$</query>
        </search>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="critical_active_vuln">
          <colorPalette type="list">[#a30000]</colorPalette>
          <scale type="threshold">1</scale>
        </format>
        <format type="color" field="high_active_vuln">
          <colorPalette type="list">[#e87000]</colorPalette>
          <scale type="threshold">1</scale>
        </format>
        <drilldown>
          <set token="asset_id">$row.asset_id$</set>
        </drilldown>
      </table>
    </panel>
  </row>
  <row depends="$asset_id$">
    <panel>
      <title>Vulnerability List - $asset_id$</title>
      <input type="multiselect" token="status" searchWhenChanged="true">
        <label>status</label>
        <choice value="open">open</choice>
        <choice value="reopened">reopened</choice>
        <choice value="fixed">fixed</choice>
        <choice value="*">All</choice>
        <default>open,reopened</default>
        <prefix>(</prefix>
        <suffix>)</suffix>
        <valuePrefix>"</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter>,</delimiter>
      </input>
      <input type="multiselect" token="severity" searchWhenChanged="true">
        <label>severity</label>
        <choice value="critical">critical</choice>
        <choice value="high">high</choice>
        <choice value="medium">medium</choice>
        <choice value="low">low</choice>
        <choice value="informational">informational</choice>
        <choice value="*">ALL</choice>
        <default>critical,high,medium</default>
        <prefix>(</prefix>
        <suffix>)</suffix>
        <valuePrefix>"</valuePrefix>
        <valueSuffix>"</valueSuffix>
        <delimiter>,</delimiter>
      </input>
      <table>
        <search base="vul_list_search">
          <query>| search status IN $status$ severity IN $severity$</query>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>
</form>