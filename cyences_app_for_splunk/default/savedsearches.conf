# Categaries #
# 1. Ransomware
# 2. Endpoint Compromise
# 3. Network Compromise
# 4. Palo Alto Firewall
# 5. Active Directoy and Windows
# 6. O365
# 7. Credential Comprimise
# 8. Sophos Central (Antivirus)
# 9. Splunk Admin
# 10. Windows Defender (Antivirus)
# 11. CrowdStrike (Antivirus)
# 12. Authentication



# Cron Details
# -------------------
# Every 10 minutes
#   - 1, 3, 4, 5, 6 and 8 's multiples
# Every 15 minutes
#   - 2, 17, 32, 47 th minutes
#   - 7, 22, 37, 52 th minutes
# Every 30 minutes
#   - 9, 39th minutes or 19, 49th minutes
# Hourly
#   - 29, 59th minutes
# Daily, Weekly, Monthly, Yearly
#   - At 0th Minute

# Severity Chart
# -----------------
# 5 - Critical
# 4 - High
# 3 - Medium
# 2 - Low
# 1 - Info



# ============
# Ransomware
# ============
# Reports
[Ransomware - Calculate UpperBound for Spike in File Writes]
disabled = 1
enableSched = 1
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0 1 * * *
description = Supporting Report for Ransomware - Spike in File Writes alert (Runs everyday at 4 AM) - Generates the upperBound value of file writes for each host \
For more information refer to Ransomware - Spike in File Writes alert. \
Warning - Do not run enable this search without enabling data-model acceleration on Endpoint data-model as this search will reduce the system performance without acceleration.
dispatch.earliest_time = -7d@d
dispatch.latest_time = now
display.general.timeRangePicker.show = 0
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
display.visualizations.show = 0
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats `cs_summariesonly_endpoint` count FROM datamodel=Endpoint.Filesystem where Filesystem.action=created by _time span=1h, Filesystem.dest | `drop_dm_object_name(Filesystem)` \
| eventstats max(_time) as maxtime \
| stats avg(eval(if(_time<relative_time(maxtime, "-1d@d"), count,null))) as avg stdev(eval(if(_time<relative_time(maxtime, "-1d@d"), count, null))) as stdev by "dest" \
| eval upperBound=(avg+stdev*4) \
| outputlookup cs_ransomware_file_writes_upperbound.csv


# Alerts
[Ransomware - Spike in File Writes]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 5
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 29 * * * *
description = This alert identifies a spike in file writes that may result in ransomware writing encrypted files. \
Warning: Enable the following report, Ransomware â€“ Calculate UpperBound for Spike in File Writes, before enabling this alert. Users should have a good understanding of false positives before enabling this alert. \
\
Data Collection - TA-microsoft-sysmon - WinEventLog://Microsoft-Windows-Sysmon/Operational stanza \
\
A false positive may appear from new application installations or by copying a large number of files.
dispatch.earliest_time = -62m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats `cs_summariesonly_endpoint` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Filesystem where Filesystem.action=created by Filesystem.dest | `drop_dm_object_name(Filesystem)` \
| `cs_human_readable_time_format(firstTime)` \
| `cs_human_readable_time_format(lastTime)` \
| lookup cs_ransomware_file_writes_upperbound.csv dest OUTPUT upperBound | where count>upperBound \
| `cs_spike_in_file_writes_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Ransomware
action.summary_index.alert_name = Ransomware - Spike in File Writes


[Ransomware - Endpoint Compromise - Fake Windows Processes]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 5
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 1,11,21,31,41,51 * * * *
description = This alert identifies processes which try to disguise themselves as a Windows process.\
\
Data Collection - TA-microsoft-sysmon - WinEventLog://Microsoft-Windows-Sysmon/Operational stanza - EventCode=1
dispatch.earliest_time = -12m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats `cs_summariesonly_endpoint` count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes where Processes.process_path !="C:\\Windows\\System32*" Processes.process_path !="C:\\Windows\\SysWOW64*" by Processes.user Processes.dest Processes.process_name Processes.process_id Processes.process_path Processes.parent_process_name Processes.process_hash \
| `drop_dm_object_name("Processes")` \
| `cs_human_readable_time_format(firstTime)` \
| `cs_human_readable_time_format(lastTime)` \
| `is_windows_system_file` \
| `cs_system_processes_run_from_unexpected_locations_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Ransomware
action.summary_index.alert_name = Ransomware - Endpoint Compromise - Fake Windows Processes


[Ransomware - Endpoint Compromise - Network Compromise - TOR Traffic]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 5
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 3,13,23,33,43,53 * * * *
description = This alert will focus on firewall data (Network_Traffic datamodel) to detect TOR traffic. \
\
Data Collection - Any firewall data that complies with the CIM definition. The alert will look for app=tor value.
dispatch.earliest_time = -12m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats `cs_summariesonly_network_traffic` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.app=tor AND All_Traffic.action=allowed by All_Traffic.src_ip All_Traffic.dest_ip All_Traffic.dest_port All_Traffic.action \
| `cs_human_readable_time_format(firstTime)` | `cs_human_readable_time_format(lastTime)` | `drop_dm_object_name("All_Traffic")` \
| `cs_tor_traffic_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Ransomware
action.summary_index.alert_name = Ransomware - Endpoint Compromise - Network Compromise - TOR Traffic


[Ransomware - Common Ransomware File Extensions]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 5
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 4,14,24,34,44,54 * * * *
description = This alert is based on a lookup from the ES Content Update app. It will inspect for common ransomware file extensions. \
\
Data Collection - TA-microsoft-sysmon - WinEventLog://Microsoft-Windows-Sysmon/Operational stanza
dispatch.earliest_time = -12m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats `cs_summariesonly_endpoint` count min(_time) as firstTime max(_time) as lastTime values(Filesystem.user) as user values(Filesystem.dest) as dest values(Filesystem.file_path) as file_path from datamodel=Endpoint.Filesystem by Filesystem.file_name \
| `drop_dm_object_name(Filesystem)` | `cs_human_readable_time_format(lastTime)` | `cs_human_readable_time_format(firstTime)` \
| rex field=file_name "(?<file_extension>\.[^\.]+)$" | `cs_ransomware_extensions` \
| `cs_common_ransomware_extensions_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Ransomware
action.summary_index.alert_name = Ransomware - Common Ransomware File Extensions


[Ransomware - Scheduled tasks used in BadRabbit ransomware]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 5
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 6,16,26,36,46,56 * * * *
description = This alert identifies BadRabbit ransomware based on processed data. It examines data from the schtasks.exe process.\
\
Data Collection - TA-microsoft-sysmon - WinEventLog://Microsoft-Windows-Sysmon/Operational stanza - EventCode=1 (uses data-model query)
dispatch.earliest_time = -12m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats `cs_summariesonly_endpoint` count min(_time) as firstTime max(_time) as lastTime values(Processes.process) as process from datamodel=Endpoint.Processes where Processes.process_name=schtasks.exe (Processes.process= "*create*"  OR Processes.process= "*delete*") by Processes.dest Processes.parent_process Processes.process_name Processes.user \
| `drop_dm_object_name("Processes")` | `cs_human_readable_time_format(firstTime)` | `cs_human_readable_time_format(lastTime)` \
| search (process=*rhaegal* OR process=*drogon* OR *viserion_*) \
| `cs_scheduled_tasks_used_in_badrabbit_ransomware_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Ransomware
action.summary_index.alert_name = Ransomware - Scheduled tasks used in BadRabbit ransomware


[Ransomware - Common Ransomware Notes]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 5
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 8,18,28,38,48,58 * * * *
description = This alert is based on a lookup from the ES Content Update app. It will inspect for common ransomware notes. \
\
Data Collection - TA-microsoft-sysmon - WinEventLog://Microsoft-Windows-Sysmon/Operational stanza
dispatch.earliest_time = -12m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats `cs_summariesonly_endpoint` count min(_time) as firstTime max(_time) as lastTime values(Filesystem.user) as user values(Filesystem.dest) as dest values(Filesystem.file_path) as file_path from datamodel=Endpoint.Filesystem by Filesystem.file_name \
| `drop_dm_object_name(Filesystem)` | `cs_human_readable_time_format(lastTime)` | `cs_human_readable_time_format(firstTime)` \
| rex field=file_name "(?<file_extension>\.[^\.]+)$" | `ransomware_notes` \
| `cs_common_ransomware_notes_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Ransomware
action.summary_index.alert_name = Ransomware - Common Ransomware Notes


[Ransomware - Endpoint Compromise - USN Journal Deletion on Windows]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 5
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 1,11,21,31,41,51 * * * *
description = The fsutil.exe application is a legitimate Windows utility used to perform tasks related to the file allocation table (FAT) and NTFS file systems. The update sequence number (USN) change journal provides a log of all changes made to the files on the disk. This search looks for fsutil.exe deleting the USN journal.\
\
Data Collection - TA-microsoft-sysmon - WinEventLog://Microsoft-Windows-Sysmon/Operational stanza - EventCode=1 (uses data-model query)
dispatch.earliest_time = -12m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats `cs_summariesonly_endpoint` count values(Processes.process) as process values(Processes.parent_process) as parent_process min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=fsutil.exe by Processes.user Processes.process_name Processes.parent_process_name Processes.dest \
| `drop_dm_object_name(Processes)` | `cs_human_readable_time_format(firstTime)` | `cs_human_readable_time_format(lastTime)` \
| search process="*deletejournal*" AND process="*usn*" \
| `cs_usn_journal_deletion_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Ransomware
action.summary_index.alert_name = Ransomware - Endpoint Compromise - USN Journal Deletion on Windows


[Ransomware - Windows - Windows Event Log Cleared]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 3,13,23,33,43,53 * * * *
description = This alert monitors for when WinEventLog events are cleared. \
\
Data Collection - Splunk_TA_Windows - WinEventLog://Security stanza and WinEventLog://System stanza\
\
A false positive may appear when an administrator might have intentionally cleared the events.
dispatch.earliest_time = -12m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = (`cs_wineventlog_security` (EventCode=1102 OR EventCode=1100)) OR (`cs_wineventlog_system` EventCode=104) \
| stats count min(_time) as firstTime max(_time) as lastTime by dest, EventCode, LogName, User | `cs_human_readable_time_format(firstTime)` | `cs_human_readable_time_format(lastTime)` \
| `cs_windows_event_log_cleared_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Ransomware
action.summary_index.alert_name = Ransomware - Windows - Windows Event Log Cleared


[Ransomware - Endpoint Compromise - Windows - WMI Lateral Movement]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 4,14,24,34,44,54 * * * *
description = This alert recognizes WMI lateral movement on Windows machines. These alerts may be due to ransomware activity on the host. \
\
Data Collection - TA-microsoft-sysmon - WinEventLog://Microsoft-Windows-Sysmon/Operational stanza - EventCode=1 (Process create information)
dispatch.earliest_time = -12m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_sysmon` EventCode=1 Image=*wmic* CommandLine="*/node*" CommandLine="*process call create*" \
| table _time, TimeCreated, Computer, User, signature, direction, Image, CommandLine \
| `cs_human_readable_time_format(_time, event_time)` \
| `cs_windows_wmi_lateral_movement_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Ransomware
action.summary_index.alert_name = Ransomware - Endpoint Compromise - Windows - WMI Lateral Movement



# ================
# Windows / AD
# ================
# Reports
[Windows - Hosts Lookup Gen]
disabled = 0
enableSched = 1
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0 2 * * 0
description = Supporting Report for Windows update check alert (Runs every Sunday at 3 AM) - Generates the host list in the lookup
dispatch.earliest_time = -7d@h
dispatch.latest_time = now
display.general.timeRangePicker.show = 0
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
display.visualizations.show = 0
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats count where `cs_wineventlog_system` by host | table host | append [| inputlookup all_windows_hosts.csv] | dedup host | outputlookup all_windows_hosts.csv

[AD - cs_ad_obj_domain - Lookup Gen]
disabled = 0
enableSched = 0
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0 1 * * *
description = Supporting Report for AD Alerts which update required lookups. (Runs every day @1AM)\
\
Data collection - Splunk_TA_windows - MSAD Health Logs (sourcetype=*Health)
dispatch.earliest_time = -24h@h
dispatch.latest_time = @h
display.general.timeRangePicker.show = 0
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
display.visualizations.show = 0
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_ad_health_logs` \
| fields host, DomainNetBIOSName,DomainDNSName,ForestName,Site \
| stats count by host, DomainNetBIOSName,DomainDNSName,ForestName,Site \
| eval DomainDNSName=lower(DomainDNSName),ForestName=lower(ForestName),Site=lower(Site),host=lower(host),DomainNetBIOSName=lower(DomainNetBIOSName) \
| eval domain=DomainNetBIOSName \
| table host,domain,DomainNetBIOSName,DomainDNSName,ForestName,Site \
| sort ForestName,Site,DomainDNSName,host \
| eval _key = host \
| outputlookup cs_ad_obj_domain append=true


[AD - cs_ad_obj_group - Lookup Gen]
disabled = 0
enableSched = 0
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 29 * * * *
description = Supporting Report for AD Alerts which update required lookups. (Runs every hour) \
\
Data collection - Splunk_TA_windows - admon stanza (sourcetype=ActiveDirectory)
dispatch.earliest_time = -65m@m
dispatch.latest_time = -5m@m
display.general.timeRangePicker.show = 0
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
display.visualizations.show = 0
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_ad_active_directory` "objectClass=top|group" ("admonEventType=Sync" OR "admonEventType=Update" OR "admonEventType=Deleted") \
| fields DomainDNSName, OU, admonEventType, adminCount, c, cn, orig_cn, dSCorePropagationData, dcName, deletedDate, description, displayName, distinguishedName, dn, dn_hist, dn_path, domain, groupType, groupType_Name, guid_lookup, instanceType, isCriticalSystemObject, isDeleted, isRecycled, l, lastKnownParent, managedBy, member, name, objectCategory, objectClass, objectGUID, objectSid, primaryGroupToken, sAMAccountName, sAMAccountType, showInAdvancedViewOnly, sid_lookup, st, systemFlags, uSNChanged, uSNCreated, whenChanged, whenCreated \
| rex field=distinguishedName max_match=0 "\\,DC\\=(?<DomainDNSName>[^(\\,|$)]+)" \
| eval DomainDNSName=mvjoin(lower(DomainDNSName),".") \
| stats max(_time) AS time,earliest(distinguishedName) AS orig_evt_dn,values(distinguishedName) AS dn_hist_hold,latest(*) AS * by objectGUID \
| rex field=cn "(?<orig_cn>[a-zA-Z0-9._\\-\\s,\\$(.+\\x5C{1}.+)[^\\sDEL:]+)\\sDEL:" \
| rex field=objectSid "\\d+\\-(?<primaryGroupToken>\\d+)$" \
| eval distinguishedName=lower(distinguishedName), displayName=if(isnull(displayName),if(isnull(cn),orig_cn,cn),displayName), dn=lower(distinguishedName), last_evt_flg=admonEventType, cn=lower(cn), lastKnownParent=lower(lastKnownParent), objectGUID=lower(objectGUID), DomainDNSName=lower(DomainDNSName), OU=lower(OU), sAMAccountName=lower(sAMAccountName), dNSHostName=if(isnull(dNSHostName),if(isnull(orig_cn),((displayName . ".") . DomainDNSName),((orig_cn . ".") . DomainDNSName)),dNSHostName), orig_evt_dn=lower(orig_evt_dn), member=lower(member), adminCount=if(isnull(adminCount),0,adminCount) \
| rex field=distinguishedName "(?i)(?:\\,(?<!\\x5C{1}))(?<dn_path>(cn|ou|dc)\\=[^$]+)" \
| rex field=distinguishedName "(?i)(?:\\,(?<!\\x5C{1}))(cn|ou|dc)\\=(?<orig_ou>[^\\,]+)" \
| fillnull value="FALSE" isRecycled,isDeleted,isCriticalSystemObject,showInAdvancedViewOnly \
| eval deletedDate=if((match(lower(last_evt_flg),"deleted") OR match(lower(isDeleted),"true")),strptime(whenChanged,"%I:%M.%S %p, %a %m/%d/%Y"),0), OU=if(isnull(OU),orig_ou,OU) \
| join type=left DomainDNSName \
    [| inputlookup cs_ad_obj_domain \
    | stats count by DomainDNSName,domain \
    | table DomainDNSName, domain] \
| lookup cs_ad_audit_group_details groupType,sAMAccountType OUTPUT groupType_Name,MSADGroupType,MSADGroupClass \
| eval isDistributionList=if((sAMAccountType == "268435457"),"TRUE","FALSE") \
| eval dn_hist_cnt=mvcount(dn_hist_hold) \
| eval dn_hist=if((dn_hist_cnt > 1),lower(dn_hist_hold),""), src_nt_domain=domain \
| fillnull value=0 uSNChanged,uSNCreated,whenChanged,whenCreated \
| fillnull value="" OU,c,orig_cn,dSCorePropagationData,dcName,description,displayName,distinguishedName,dn,dn_path,groupType,groupType_Name,MSADGroupType,MSADGroupClass,guid_lookup,instanceType,l,lastKnownParent,last_evt_flg,managedBy,member,name,objectCategory,objectSid,primaryGroupToken,sAMAccountName,sAMAccountType,sid_lookup,st,systemFlags,uSNChanged,uSNCreated \
| eval d_dn=if(dn_hist=="",dn,mvjoin(dn_hist,"|")),d_cn=if(orig_cn=="",cn,cn."|".orig_cn),d_sam=if(sAMAccountName==cn,"",sAMAccountName) \
| eval lookup_grp=lower(d_cn)."|".lower(d_dn)."|".lower(d_sam) \
| makemv delim="|" lookup_grp \
| makemv delim="|" member \
| eval membercount=if((member == ""),0,mvcount(member)) \
| eval key_val=((objectGUID . "#") . DomainDNSName) \
| table key_val, DomainDNSName, OU, adminCount, c, cn, orig_cn, dSCorePropagationData, dcName, deletedDate, description, displayName, distinguishedName, dn, dn_hist, dn_path, domain, groupType, groupType_Name, guid_lookup, instanceType, isCriticalSystemObject, isDeleted, isDistributionList, isRecycled, l, lastKnownParent, last_evt_flg, lookup_grp, managedBy, member, membercount, MSADGroupType, MSADGroupClass, name, objectCategory, objectClass, objectGUID, objectSid, orig_evt_dn, primaryGroupToken, sAMAccountName, sAMAccountType, showInAdvancedViewOnly, sid_lookup, src_nt_domain, st, systemFlags, uSNChanged, uSNCreated, whenChanged, whenCreated, time \
| lookup cs_ad_obj_group domain,objectGUID OUTPUT lookup_grp AS p_lookup_grp \
| eval lookup_grp=if(isnull(p_lookup_grp),mvjoin(lookup_grp,"|"),mvjoin(lookup_grp,"|")."|".mvjoin(p_lookup_grp,"|")) \
| eval key_val=((objectGUID . "#") . DomainDNSName) \
| makemv delim="|" lookup_grp \
| fields - p_lookup_grp \
| stats values(*) AS * by key_val \
| eval _key=key_val \
| outputlookup cs_ad_obj_group append=true


[AD - cs_ad_obj_gpo - Lookup Gen]
disabled = 0
enableSched = 0
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 29 * * * *
description = Supporting Report for AD Alerts which update required lookups. (Runs every hour) \
\
Data collection - Splunk_TA_windows - admon stanza (sourcetype=ActiveDirectory)
dispatch.earliest_time = -65m@m
dispatch.latest_time = -5m@m
display.general.timeRangePicker.show = 0
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
display.visualizations.show = 0
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_ad_active_directory` "objectClass=top|container|groupPolicyContainer" ("admonEventType=Sync" OR "admonEventType=Update" OR "admonEventType=Deleted") \
| fields admonEventType,cn,deletedDate,displayName,distinguishedName,dn,dn_hist,domain,DomainDNSName,dSCorePropagationData,flags,gpo_link,gPCFileSysPath,gPCFunctionalityVersion,gPCMachineExtensionNames,instanceType,isCriticalSystemObject,isRecycled,isDeleted,lastKnownParent,lc,last_evt_flg,name,objectCategory,objectClass,objectGUID,orig_cn,showInAdvancedViewOnly,systemFlags,uSNChanged,uSNCreated,versionNumber,whenChanged,whenCreated,_time \
| rex max_match=0 field=distinguishedName "\,DC\=(?<DomainDNSName>[^(\,|$)]+)" \
| eval DomainDNSName=mvjoin(DomainDNSName,".") \
| stats max(_time) AS time,earliest(distinguishedName) AS orig_evt_dn,values(distinguishedName) AS dn_hist_hold,latest(*) AS * by objectGUID \
| rex field=cn "(?<orig_cn>[a-zA-Z0-9._\-\s,\$(.+\x5C{1}.+)[^\sDEL:]+)\sDEL:" \
| rex field=distinguishedName "(?msi)(?:CN\=\{)(?<gpo_link>[^\}]+)\}\,CN\=Policies" \
| eval distinguishedName=lower(distinguishedName),displayName=if(isnull(displayName),if(isnull(cn),orig_cn,cn),displayName),dn=lower(distinguishedName),last_evt_flg=admonEventType,cn=lower(cn),orig_cn=lower(orig_cn),lastKnownParent=lower(lastKnownParent),objectGUID=lower(objectGUID),DomainDNSName=lower(DomainDNSName),orig_evt_dn=lower(orig_evt_dn),gpo_link=lower(gpo_link) \
| rex field=distinguishedName "(?i)(?:\,(?<!\x5C{1}))(cn|ou|dc)\=(?<orig_ou>[^\,]+)" \
| fillnull value="FALSE" isRecycled,isDeleted,isCriticalSystemObject,showInAdvancedViewOnly \
| eval deletedDate=if(match(lower(last_evt_flg), "deleted") OR match(lower(isDeleted), "true"), strptime(whenChanged, "%I:%M.%S %p, %a %m/%d/%Y"), 0),OU=if(isnull(OU),orig_ou,OU) \
| join type=left DomainDNSName \
    [| inputlookup cs_ad_obj_domain \
    | stats count by DomainDNSName,domain \
    | table DomainDNSName,domain] \
| eval dn_hist_cnt=mvcount(dn_hist_hold) \
| eval dn_hist=if(dn_hist_cnt>1,lower(dn_hist_hold),"") \
| fillnull value=0 uSNChanged,uSNCreated,whenChanged,whenCreated \
| fillnull value="" displayName,distinguishedName,dn,dn_hist,domain,DomainDNSName,dSCorePropagationData,flags,gpo_link,gPCFileSysPath,gPCFunctionalityVersion,gPCMachineExtensionNames,instanceType,lastKnownParent,lc,last_evt_flg,name,objectCategory,objectClass,objectGUID,orig_cn,systemFlags,uSNChanged,uSNCreated,versionNumber \
| eval key_val=objectGUID."#".DomainDNSName \
| table key_val,cn,deletedDate,displayName,distinguishedName,dn,dn_hist,domain,DomainDNSName,dSCorePropagationData,flags,gpo_link,gPCFileSysPath,gPCFunctionalityVersion,gPCMachineExtensionNames,instanceType,isCriticalSystemObject,isRecycled,isDeleted,lastKnownParent,lc,last_evt_flg,name,objectCategory,objectClass,objectGUID,orig_cn,showInAdvancedViewOnly,systemFlags,uSNChanged,uSNCreated,versionNumber,whenChanged,whenCreated,time \
| stats values(*) AS * by key_val \
| eval _key=key_val \
| outputlookup cs_ad_obj_gpo append=true


[AD - cs_ad_obj_user - Lookup Gen]
disabled = 0
enableSched = 0
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 29 * * * *
description = Supporting Report for AD Alerts which update required lookups. (Runs every hour) \
\
Data collection - Splunk_TA_windows - admon stanza (sourcetype=ActiveDirectory)
dispatch.earliest_time = -65m@m
dispatch.latest_time = -5m@m
display.general.timeRangePicker.show = 0
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
display.visualizations.show = 0
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_ad_active_directory` "objectClass=*|person|organizationalPerson|user" NOT "objectClass=top|person|organizationalPerson|user|computer" ("admonEventType=Sync" OR "admonEventType=Update" OR "admonEventType=Deleted") \
| fields _time,DomainDNSName,OU,accountExpires,adminCount,badPasswordTime,badPwdCount,c,cn,orig_cn,codePage,countryCode,dSCorePropagationData,dcName,deletedDate,department,description,displayName,distinguishedName,dn,dn_path,domain,givenName,guid_lookup,initials,instanceType,isCriticalSystemObject,isDeleted,isRecycled,l,lastKnownParent,lastLogon,lastLogonTimestamp,admonEventType,lockoutTime,logonCount,logonHours,managedBy,msDS-SupportedEncryptionTypes,name,objectCategory,objectClass,objectGUID,objectSid,physicalDeliveryOfficeName,postalCode,primaryGroupID,pwdLastSet,sAMAccountName,sAMAccountType,servicePrincipalName,showInAdvancedViewOnly,sid_lookup,sn,st,streetAddress,title,uSNChanged,uSNCreated,userAccountControl,userPrincipalName,userWorkstations,whenChanged,whenCreated \
| rex max_match=0 field=distinguishedName "\,DC\=(?<DomainDNSName>[^(\,|$)]+)" \
| eval DomainDNSName=mvjoin(lower(DomainDNSName),".") \
| stats max(_time) AS time,earliest(distinguishedName) AS orig_evt_dn,values(distinguishedName) AS dn_hist_hold,latest(*) AS * by objectGUID \
| rex field=cn "(?<orig_cn>[a-zA-Z0-9._\-\s,\$(.+\x5C{1}.+)[^\sDEL:]+)\sDEL:" \
| eval distinguishedName=lower(distinguishedName),displayName=if(isnull(displayName),if(isnull(cn),orig_cn,cn),displayName),dn=lower(distinguishedName),last_evt_flg=admonEventType,cn=lower(cn),lastKnownParent=lower(lastKnownParent),user_type="user",objectGUID=lower(objectGUID),DomainDNSName=lower(DomainDNSName),OU=lower(OU),sAMAccountName=lower(sAMAccountName),userPrincipalName=lower(userPrincipalName),orig_evt_dn=lower(orig_evt_dn) \
| rex field=distinguishedName "(?i)(?:\,(?<!\x5C{1}))(?<dn_path>(cn|ou|dc)\=[^$]+)" \
| fillnull value="FALSE" isRecycled,isDeleted,isCriticalSystemObject,showInAdvancedViewOnly \
| eval deletedDate=if(match(lower(last_evt_flg), "deleted") OR match(lower(isDeleted), "true"), strptime(whenChanged, "%I:%M.%S %p, %a %m/%d/%Y"), 0) \
| lookup cs_ad_obj_uac userAccountControl OUTPUT uac_bin_map, uac_details \
| join type=left DomainDNSName \
    [| inputlookup cs_ad_obj_domain \
    | stats count by DomainDNSName,domain \
    | table DomainDNSName,domain] \
| eval dn_hist_cnt=mvcount(dn_hist_hold) \
| eval dn_hist=if(dn_hist_cnt>1,lower(dn_hist_hold),"") \
| fillnull value=0 adminCount,badPwdCount,lastLogonTimestamp,logonCount,primaryGroupID,pwdLastSet,uSNChanged,uSNCreated,userAccountControl,whenChanged,whenCreated \
| fillnull value="" OU,accountExpires,badPasswordTime,c,cn,orig_cn,codePage,countryCode,dSCorePropagationData,dcName,department,description,displayName,distinguishedName,dn,dn_hist,dn_path,domain,givenName,guid_lookup,initials,instanceType,l,lastKnownParent,last_evt_flg,lockoutTime,logonHours,managedBy,msDS-SupportedEncryptionTypes,name,objectCategory,objectClass,objectGUID,objectSid,orig_evt_dn,physicalDeliveryOfficeName,postalCode,primaryGroupID,sAMAccountName,sAMAccountType,servicePrincipalName,sid_lookup,sn,st,streetAddress,title,uSNChanged,uSNCreated,uac_details,userPrincipalName,userWorkstations,uac_bin_map \
| eval d_dn=if(dn_hist=="",dn,mvjoin(dn_hist,"|")),d_cn=if(orig_cn=="",cn,cn."|".orig_cn),d_sam=if(sAMAccountName=cn,"",lower(sAMAccountName)),d_princ=if(userPrincipalName=="","",userPrincipalName) \
| eval key_val=objectGUID."#".DomainDNSName,lookup_usr=lower(d_cn)."|".lower(d_dn)."|".d_sam."|".d_princ \
| makemv delim="|" lookup_usr \
| eventstats values(lookup_usr) AS lookup_usr by key_val \
| table key_val,DomainDNSName,OU,accountExpires,adminCount,badPasswordTime,badPwdCount,c,cn,orig_cn,codePage,countryCode,dSCorePropagationData,dcName,deletedDate,department,description,displayName,distinguishedName,dn,dn_hist,dn_path,domain,givenName,guid_lookup,initials,instanceType,isCriticalSystemObject,isDeleted,isRecycled,l,lastKnownParent,lastLogon,lastLogonTimestamp,last_evt_flg,lockoutTime,logonCount,logonHours,lookup_usr,managedBy,msDS-SupportedEncryptionTypes,name,objectCategory,objectClass,objectGUID,objectSid,orig_evt_dn,physicalDeliveryOfficeName,postalCode,primaryGroupID,pwdLastSet,sAMAccountName,sAMAccountType,servicePrincipalName,showInAdvancedViewOnly,sid_lookup,sn,st,streetAddress,title,uac_details,uSNChanged,uSNCreated,userAccountControl,userPrincipalName,userWorkstations,whenChanged,whenCreated,user_type,time \
| lookup cs_ad_obj_user domain,objectGUID OUTPUT lookup_usr AS p_lookup_usr \
| eval lookup_usr=if(isnull(p_lookup_usr),mvjoin(lookup_usr,"|"),mvjoin(lookup_usr,"|")."|".mvjoin(p_lookup_usr,"|")) \
| eval key_val=((objectGUID . "#") . DomainDNSName) \
| makemv delim="|" lookup_usr \
| fields - p_lookup_usr \
| stats values(*) AS * by key_val \
| eval _key=key_val \
| outputlookup cs_ad_obj_user append=true


# Alerts
[Windows - Hosts Missing Update]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 0 3 1 * *
description = This alert is for Windows hosts that haven't received the latest update. It automatically runs on the first of every month and checks for any updates that might have been released in the previous month. \
\
Data collection - WinEventLog System events (EventCode=19)
dispatch.earliest_time = -31d
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_wineventlog_system` EventCode=19 | dedup host | table host | eval updated="true" | append [| inputlookup all_windows_hosts.csv | table host] \
| stats first(updated) as updated by host | search NOT updated="true" \
| `cs_windows_host_missing_update_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Windows
action.summary_index.alert_name = Windows - Hosts Missing Update


[Windows - Endpoint Compromise - Windows Firewall Disabled Event]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 5
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 6,16,26,36,46,56 * * * *
description = Windows Firewall Disabled Event from WinEventLog\
\
Data Collection - WinEventLog Security Events (EventCode=4950)
dispatch.earliest_time = -12m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_wineventlog_security` EventCode=4950 SettingType="Enable Windows Defender Firewall" SettingValue=No | table _time, host, EventCode, ProfileChanged, SettingType, SettingValue\
| `cs_human_readable_time_format(_time, event_time)` \
| `cs_windows_firewall_disabled_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Windows
action.summary_index.alert_name = Windows - Endpoint Compromise - Windows Firewall Disabled Event


[Windows - Windows Process Tampering Detected]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 5
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 5,15,25,35,45,55 * * * *
description = Windows process tampering detected by sysmon.\
\
Data Collection - TA-microsoft-sysmon - WinEventLog://Microsoft-Windows-Sysmon/Operational stanza - EventCode=25
dispatch.earliest_time = -12m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_sysmon` EventCode=25 \
| table _time, Computer, User, Type, ProcessId, Image, CommandLine \
| `cs_human_readable_time_format(_time, event_time)` \
| `cs_windows_process_tampering_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Windows
action.summary_index.alert_name = Windows - Windows Process Tampering Detected

[AD - Group Changed]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 3
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 9,39 * * * *
description = Change in Active Directory Group.\
\
Data Collection - Splunk_TA_windows - WinEventLog://Security stanza
dispatch.earliest_time = -32m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `ms_obj_changes_base_cat("Group")` \
| `ms_obj_group_change_out`\
| fields - member_obj_lkp\
| rename adminuser as "Administrator",msad_action as "Action",group_obj_nm as "Group Name",MSADGroupType as "Group Type",MSADGroupClass AS "Group Class",signature as "Changes" \
| `cs_ad_group_changed_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = AD
action.summary_index.alert_name = AD - Group Changed


[AD - Group Policy Changed]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 3
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 19,49 * * * *
description = Change in Active Directory Group Policy.\
\
Data Collection - Splunk_TA_windows - WinEventLog://Security stanza
dispatch.earliest_time = -32m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `ms_obj_changes_base_cat("Group Policy")`\
| fields _time, session_id, src_nt_domain, src_user,Object_Name_Guid,displayName,dir_svcs_action,AttributeLDAPDisplayName,AttributeValue,MSADChangedAttributes,Correlation_ID,signature,msad_action,Old_DN,New_DN\
| fillnull value="" Correlation_ID,msad_action\
| eval adminuser=if(isnull(src_nt_domain),src_user,src_nt_domain."\\".src_user) \
| eval Object_Lookup_Name="{".lower(Object_Name_Guid)."}" \
| join type=left Object_Lookup_Name [| inputlookup cs_ad_obj_gpo | fields cn, displayName | rename cn AS Object_Lookup_Name | table Object_Lookup_Name, displayName]\
| eval displayName=if(isnull(displayName),"Warning: ".Object_Lookup_Name." GPO CN not found in the AD_Obj_GPO Lookup. If GPO is new wait 15 minutes and run report again, or check that ms_ad_obj_sched_sync_gpo scheduled search is running as scheduled.",displayName) \
| `ms_obj_msad-changed-attributes`\
| stats max(_time) AS last_time, min(_time) AS start_time,list(MSADChanges) AS MSADChanges,values(Correlation_ID) AS Correlation_IDs by session_id,Object_Lookup_Name,displayName,adminuser,signature,msad_action\
| eval MSADChanges=mvjoin(MSADChanges, "########")\
| eval MSADChanges=case(isnull(signature) AND isnull(MSADChanges),"Unknown Changes",isnull(signature),MSADChanges,isnotnull(MSADChanges),"Signature: ".signature."########".MSADChanges)\
| eval Session_Time="Session ID (".session_id.")|Start: ".strftime(start_time,"%m/%d/%y %I:%M:%S %P")."|End: ".strftime(last_time,"%m/%d/%y %I:%M:%S %P")\
| table displayName,adminuser,Session_Time,msad_action,Correlation_IDs,MSADChanges\
| makemv delim="########" MSADChanges\
| makemv delim="|" Session_Time\
| rename adminuser as "Administrator",msad_action as "Action",displayName as "GPO Name",MSADChanges as "Changes" \
| `cs_ad_group_policy_changed_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = AD
action.summary_index.alert_name = AD - Group Policy Changed


[AD - User Changed]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 3
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 9,39 * * * *
description = User Changed.\
\
Data Collection - Splunk_TA_windows - WinEventLog://Security stanza
dispatch.earliest_time = -32m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `ms_obj_changes_base_cat("User")`\
| `ms_obj_user_change_out`\
| rename adminuser as "Administrator",msad_action as "Action",dest_user_subject as "Target User ID",MSADChanges as "Changes" \
| `cs_ad_user_changed_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = AD
action.summary_index.alert_name = AD - User Changed


[AD - User Locked Out]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 3
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 19,49 * * * *
description = User Changed.\
\
Data Collection - Splunk_TA_windows - WinEventLog://Security stanza
dispatch.earliest_time = -32m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_wineventlog_security` (EventCode=4740) \
| eval Account_Name=mvfilter(NOT match(Account_Name, "\$")) \
| fields ComputerName Account_Domain Account_Name Caller_Computer_Name \
| rename ComputerName as "Domain_Controller", Account_Domain as User_Domain ,Account_Name as "User_Name", Caller_Computer_Name as "Source_Computer_Name" \
| fillnull value="-" Source_Computer_Name \
| table _time,User_Name,User_Domain,Source_Computer_Name * \
| `cs_human_readable_time_format(_time, event_time)` \
| `cs_ad_user_locked_out_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = AD
action.summary_index.alert_name = AD - User Locked Out


# ==============
# Network Compromise
# ==============
[Network Compromise - Basic Scanning]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 29 * * * *
description = This alert scans for hosts that either reach out to 500 or more hosts or 100 ports in a short period of time.\
\
Data Collection - Palo Alto Networks firewalls, and with any other device that uses the Splunk common information model.
dispatch.earliest_time = -62m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = index=* ( (tag=network tag=communicate) OR sourcetype=pan*traffic OR sourcetype=opsec OR sourcetype=cisco:asa) \
| stats dc(dest_port) as num_dest_port dc(dest_ip) as num_dest_ip by sourcetype, src_ip\
| where num_dest_port > 100 OR num_dest_ip > 500\
| `cs_scanning_basic_scanning_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Network Compromise
action.summary_index.alert_name = Network Compromise - Basic Scanning



# ==============
# Palo Alto Firewall
# ==============
[Palo Alto Firewall - Network Compromise - Palo Alto DNS Sinkhole]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 5
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 59 * * * *
description = A Palo Alto Firewall DNS alert for when outbound traffic goes to 72.5.65.111. \
\
Data Collection - Palo Alto Networks firewalls traffic data.
dispatch.earliest_time = -62m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_palo` sourcetype="pan:traffic" dest_ip="72.5.65.111" \
| stats count, values(dvc) as dvc, values(dvc_name) as dvc_name, dc(src_port) as dc_src_port, values(dest_port) as dest_port, values(app) as app, values(rule) as rule, values(http_category) as http_category by src_ip \
| `cs_palo_dns_sinkhole_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Palo Alto Firewall
action.summary_index.alert_name = Palo Alto Firewall - Network Compromise - Palo Alto DNS Sinkhole


[Palo Alto Firewall - Network Compromise - Palo Alto High Threats Alert]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 9,39 * * * *
description = A Palo Alto Firewall alerts for high or critical severity threats. \
\
Data Collection - Palo Alto Networks firewalls traffic data.
dispatch.earliest_time = -32m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_palo` sourcetype="pan:threat" severity IN ("high" "critical") \
| table _time, log_subtype, threat_category, app, signature, severity, action, threat, dvc, dvc_name, src, src_port, src_location, src_zone, dest, dest_port, dest_translated_ip, dest_translated_port, url \
| `cs_human_readable_time_format(_time, event_time)` \
| `cs_palo_high_threats_alert_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Palo Alto Firewall
action.summary_index.alert_name = Palo Alto Firewall - Network Compromise - Palo Alto High Threats Alert


[Palo Alto Firewall - Network Compromise - Palo Alto High System Alert]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 19,49 * * * *
description = A Palo Alto Firewall alerts for high or critical severity system events. \
\
Data Collection - Palo Alto Networks firewalls system data.
dispatch.earliest_time = -32m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_palo` sourcetype="pan:system" severity IN ("critical", "high") \
| table _time, log_subtype, signature, severity, action, description, dvc, dvc_name \
| `cs_human_readable_time_format(_time, event_time)` \
| `cs_palo_high_system_alerts_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Palo Alto Firewall
action.summary_index.alert_name = Palo Alto Firewall - Network Compromise - Palo Alto High System Alert


[Palo Alto Firewall - Network Compromise - Palo Alto WildFire Alert]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 3
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 29 * * * *
description = A Palo Alto Firewall WildFire events Alert \
\
Data Collection - Palo Alto Networks firewalls traffic data.
dispatch.earliest_time = -62m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_palo` sourcetype="pan:threat" log_subtype="wildfire" \
| table _time, app, signature, severity, action, threat, dvc, dvc_name, src, src_port, src_location, src_zone, dest, dest_port, dest_translated_ip, dest_translated_port, url \
| `cs_human_readable_time_format(_time, event_time)` \
| `cs_palo_wildfire_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Palo Alto Firewall
action.summary_index.alert_name = Palo Alto Firewall - Network Compromise - Palo Alto WildFire Alert


# Reports
[Palo Alto Firewall - Network Compromise - DDoS Attack Prevented]
disabled = 1
action.email.useNSSubject = 1
alert.track = 0
auto_summarize = 1
auto_summarize.dispatch.earliest_time = -1mon@d
description = Palo Alto Firewall prevented DDoS attack events. It searches for log_subtype=packet.\
\
Data Collection - Palo Alto Networks firewalls threat data. (Palo Alto Networks Add-on for Splunk)
search = `cs_palo` sourcetype="pan:threat" log_subtype=packet \
| stats count, latest(_time) as last_seen, dc(src_port) as dc_src_port, dc(dest_ip) as dc_dest_ip, values(signature) as signature, values(dvc) as dvc, values(dvc_name) as dvc_name, values(src_location) as src_location, dc(dest) as dc_dest, values(action) as action by src | sort - count \
| `cs_palo_ddos_prevented_filter`


[Palo Alto Firewall - Network Compromise - Inbound Traffic from Blocked IPs]
disabled = 1
action.email.useNSSubject = 1
alert.track = 0
auto_summarize = 1
auto_summarize.dispatch.earliest_time = -1mon@d
description = Network traffic coming from blocked IPs. The ip_blocked_list lookup is being used to identify the blocked IPs.\
\
Data Collection: Palo Alto pan:traffic sourcetype data. (Palo Alto Networks Add-on for Splunk)
search = `cs_palo` sourcetype="pan:traffic" action="allowed" `cs_filter_private_ips` packets_in>0 \
| stats count, latest(_time) as last_seen, values(dvc) as dvc, values(dvc_name) as dvc_name, dc(dvc_name) as dc_dvc_name, dc(src_port) as dc_src_port, values(src_location) as src_location, sum(packets_in) as packets_in, sum(packets_out) as packets_out, dc(dest_ip) as dc_dest_ip, values(dest_port) as dest_port, dc(dest_location) as dc_dest_location, values(app) as app, values(http_category) as http_category, values(rule) as firewall_rule by src_ip \
| `cs_palo_search_blocked_ip("src_ip")` | sort -count \
| `cs_palo_blocked_ip_inbound_filter`


[Palo Alto Firewall - Network Compromise - Outbound Traffic to Blocked IPs]
disabled = 1
action.email.useNSSubject = 1
alert.track = 0
auto_summarize = 1
auto_summarize.dispatch.earliest_time = -1mon@d
description = Network traffic going to blocked IPs. The ip_blocked_list lookup is being used to identify the blocked IPs.\
\
Data Collection: Palo Alto pan:traffic sourcetype data. (Palo Alto Networks Add-on for Splunk)
search = `cs_palo` sourcetype="pan:traffic" action="allowed" `cs_filter_private_ips` packets_out>0 \
| stats count, latest(_time) as last_seen, values(dvc) as dvc, values(dvc_name) as dvc_name, dc(dvc_name) as dc_dvc_name, dc(dest_port) as dc_dest_port, values(dest_location) as dest_location, sum(packets_in) as packets_in, sum(packets_out) as packets_out, dc(src_ip) as dc_src_ip, dc(src_port) as dc_src_port, dc(src_location) as dc_src_location, values(app) as app, values(http_category) as http_category, values(rule) as firewall_rule by dest_ip \
| `cs_palo_search_blocked_ip("dest_ip")` | sort -count \
| `cs_palo_blocked_ip_outbound_filter`


[Dynamically Update Blocked IPs with HoneyDB]
disabled = 1
enableSched = 1
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 29 */2 * * *
description = Runs every 2 hours and update the blocked IP lookup (ip_blocked_list.csv) with HoneyDB.\
Enable this report to dynamically update the lookup.
dispatch.earliest_time = 0
dispatch.latest_time = now
display.general.timeRangePicker.show = 0
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
display.visualizations.show = 0
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | honeydblookupgen update_lookup=true generate_events=false


[Palo Alto Firewall - Malicious IP List Gen]
disabled = 1
enableSched = 1
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 2,17,32,47 * * * *
description = Based on various firewall activities like DDoS attack or it is an already blocked IP address and connecting through multiple firewalls this report will create a list of bad IP addresses.\
The report runs every 15 minutes for last 4 hours. (To cover blocked IPs that is trying to connect to more than 2 firewall devices.) \
\
Note - Enable below three reports to make use of this report.\
1. Palo Alto Firewall - Network Compromise - DDoS Attack Prevented\
2. Palo Alto Firewall - Network Compromise - Inbound Traffic from Blocked IPs\
3. Palo Alto Firewall - Network Compromise - Outbound Traffic to Blocked IPs
dispatch.earliest_time = -4h@m
dispatch.latest_time = now
display.general.timeRangePicker.show = 0
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
display.visualizations.show = 0
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | savedsearch "Palo Alto Firewall - Network Compromise - DDoS Attack Prevented" | rename src as ip, src_location as ip_location, dc_src_port as no_of_ports_used, dc_dest_ip as no_of_victims | eval description="Involved in DDoS Attack" | eval ip_category="ddos" \
| append [| savedsearch "Palo Alto Firewall - Network Compromise - Inbound Traffic from Blocked IPs" | rename src_ip as ip, dc_src_port as no_of_ports_used, src_location as ip_location, dc_dest_ip as no_of_victims  | eval description="Incoming traffic into multiple firewalls from this blocked IP" | eval ip_category="inbound"] \
| append [| savedsearch "Palo Alto Firewall - Network Compromise - Outbound Traffic to Blocked IPs" | rename dest_ip as ip, dc_dest_port as no_of_ports_used, dest_location as ip_location, dc_src_ip as no_of_victims | eval description="Outgoing traffic through multiple firewalls to this blocked IP", last_seen=now() | eval ip_category="outbound"] \
| maliciousipupload \
| appendpipe [| maliciousiplookupgen ]
# TODO - malicioudiplookupgen command should be executed sequencially. Currently it is being executed before the maliciousipupload command.



# ==============
# Office 365 (O365)
# ==============
[O365 - DLP event in Exchange]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 0 0,6,12,18 * * *
description = This alert will pinpoint when thereâ€™s an Office 365 data loss prevention event in Microsoft Exchange. \
\
Data Collection - Office 365 management activity data (Splunk Add-on for Office 365). The user has to enable the DLP rules on the Office 365 (https://docs.microsoft.com/en-us/microsoft-365/compliance/create-test-tune-dlp-policy?view=o365-worldwide).\
\
A false positive could be generated when the query itself lacks a false positive, but the DLP rules for Office 365 might contain some. 
dispatch.earliest_time = -362m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_o365` Workload=Exchange UserId=DlpAgent \
| rename "ExchangeMetaData.From" as From, "ExchangeMetaData.To{}" as To, "ExchangeMetaData.CC{}" as CC, "ExchangeMetaData.BCC{}" as BCC, "ExchangeMetaData.Subject" as Subject, "PolicyDetails{}.PolicyName" as PolicyName, "PolicyDetails{}.Rules{}.RuleName" as RuleName, "PolicyDetails{}.Rules{}.Actions{}" as RuleActions, "PolicyDetails{}.Rules{}.ConditionsMatched.SensitiveInformation{}.Location" as SensitiveInformationLocation, "PolicyDetails{}.Rules{}.ConditionsMatched.SensitiveInformation{}.SensitiveInformationTypeName" as SensitiveInformationType, "ExchangeMetaData.FileSize" as fs \
| convert auto(fs) | eval EmailSizeInKB=round(tonumber(fs)/1024, 2) \
| table _time, host, Subject, From, To, CC, BCC, EmailSizeInKB, PolicyName, RuleName, RuleActions, SensitiveInformationType, SensitiveInformationLocation \
| `cs_human_readable_time_format(_time, event_time)` \
| `cs_o365_dlp_exchange_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = O365
action.summary_index.alert_name = O365 - DLP event in Exchange


[O365 - DLP event in SharePoint]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 0 0,6,12,18 * * *
description = This alert will pinpoint when thereâ€™s an Office 365 data loss prevention event in Microsoft SharePoint. \
\
Data Collection - Office 365 management activity data (Splunk Add-on for Office 365). The user has to enable the DLP rules on the Office 365 (https://docs.microsoft.com/en-us/microsoft-365/compliance/create-test-tune-dlp-policy?view=o365-worldwide).\
\
A false positive could be generated when the query itself lacks a false positive, but the DLP rules for SharePoint might contain some.
dispatch.earliest_time = -362m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_o365` Workload=SharePoint UserId=DlpAgent \
| rename "SharePointMetaData.From" as From, "SharePointMetaData.FileName" as FileName, "SharePointMetaData.FileOwner" as FileOwner, "SharePointMetaData.DocumentLastModifier" as User, "SharePointMetaData.FilePathUrl" as FilePathUrl, "PolicyDetails{}.PolicyName" as PolicyName, "PolicyDetails{}.Rules{}.RuleName" as RuleName, "PolicyDetails{}.Rules{}.Actions{}" as RuleActions, "PolicyDetails{}.Rules{}.ConditionsMatched.SensitiveInformation{}.Location" as SensitiveInformationLocation, "PolicyDetails{}.Rules{}.ConditionsMatched.SensitiveInformation{}.SensitiveInformationTypeName" as SensitiveInformationType \
| table _time, host, FileName, From, User, FileOwner, FilePathUrl, PolicyName, RuleName, RuleActions, SensitiveInformationType, SensitiveInformationLocation \
| `cs_human_readable_time_format(_time, event_time)` \
| `cs_o365_dlp_sharepoint_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = O365
action.summary_index.alert_name = O365 - DLP event in SharePoint



# ======================
# Credential Compromise
# ======================
[Credential Compromise - Windows - Credential Dumping through LSASS Access]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 9,39 * * * *
description = This alert points out credential dumping on Windows with LSASS Access. \
\
Data Collection - TA-microsoft-sysmon - WinEventLog://Microsoft-Windows-Sysmon/Operational stanza - EventCode=10
dispatch.earliest_time = -32m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_sysmon` EventCode=10 TargetImage=*lsass.exe (GrantedAccess=0x1010 OR GrantedAccess=0x1410) \
| stats count min(_time) as firstTime max(_time) as lastTime by Computer, SourceImage, SourceProcessId, TargetImage, TargetProcessId, EventCode, GrantedAccess \
| rename Computer as dest | `cs_human_readable_time_format(firstTime)` | `cs_human_readable_time_format(lastTime)` \
| `cs_detect_credential_dumping_through_lsass_access_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Credential Compromise
action.summary_index.alert_name = Credential Compromise - Windows - Credential Dumping through LSASS Access


[Credential Compromise - Windows - Credential Dumping via Symlink to Shadow Copy]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 19,49 * * * *
description = This alert identifies credential dumping on Windows via symlink to the shadow copy. \
\
Data Collection - TA-microsoft-sysmon - WinEventLog://Microsoft-Windows-Sysmon/Operational stanza - EventCode=1 (Process creation information)
dispatch.earliest_time = -32m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats `cs_summariesonly_endpoint` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe Processes.process=*mklink* Processes.process=*HarddiskVolumeShadowCopy* by Processes.dest Processes.user Processes.process_name Processes.process Processes.parent_process Processes.process_id Processes.parent_process_id \
| `drop_dm_object_name(Processes)` | `cs_human_readable_time_format(firstTime)` | `cs_human_readable_time_format(lastTime)` \
| `cs_credential_dumping_via_symlink_to_shadow_copy_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Credential Compromise
action.summary_index.alert_name = Credential Compromise - Windows - Credential Dumping via Symlink to Shadow Copy


[Credential Compromise - Windows - Credential Dumping via Copy Command from Shadow Copy]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 9,39 * * * *
description = This alert recognizes credential dumping via copy command from a shadow copy. \
\
Data Collection - TA-microsoft-sysmon - WinEventLog://Microsoft-Windows-Sysmon/Operational stanza - EventCode=1 (Process creation information)
dispatch.earliest_time = -32m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats `cs_summariesonly_endpoint` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.process_name=cmd.exe (Processes.process=*\\system32\\config\\sam* OR Processes.process=*\\system32\\config\\security* OR Processes.process=*\\system32\\config\\system* OR Processes.process=*\\windows\\ntds\\ntds.dit*) by Processes.dest Processes.user Processes.process_name Processes.process Processes.parent_process Processes.process_id Processes.parent_process_id \
| `drop_dm_object_name(Processes)` | `cs_human_readable_time_format(firstTime)` | `cs_human_readable_time_format(lastTime)` \
| `cs_credential_dumping_via_copy_command_from_shadow_copy_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Credential Compromise
action.summary_index.alert_name = Credential Compromise - Windows - Credential Dumping via Copy Command from Shadow Copy


[Credential Compromise - Windows - Credential Dump From Registry via Reg exe]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 19,49 * * * *
description = This alert identifies credential dumping from registry via reg exe. \
\
Data Collection - TA-microsoft-sysmon - WinEventLog://Microsoft-Windows-Sysmon/Operational stanza - EventCode=1 (Process creation information)
dispatch.earliest_time = -32m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats `cs_summariesonly_endpoint` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.process_name=reg.exe OR Processes.process_name=cmd.exe) Processes.process=*save* (Processes.process=*HKEY_LOCAL_MACHINE\\Security* OR Processes.process=*HKEY_LOCAL_MACHINE\\SAM* OR Processes.process=*HKEY_LOCAL_MACHINE\\System* OR Processes.process=*HKLM\\Security* OR Processes.process=*HKLM\\System* OR Processes.process=*HKLM\\SAM*) by Processes.user Processes.process_name Processes.process Processes.dest \
| `drop_dm_object_name(Processes)` | `cs_human_readable_time_format(firstTime)` | `cs_human_readable_time_format(lastTime)` \
| `cs_attempted_credential_dump_from_registry_via_reg_exe_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Credential Compromise
action.summary_index.alert_name = Credential Compromise - Windows - Credential Dump From Registry via Reg exe



# ======================
# Sophos Central
# ======================
[Sophos - Endpoint Not Protected by Sophos]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 7,22,37,52 * * * *
description = This alert will trigger when a Sophos endpoint is unprotected. \
\
Data Collection - Sophos Central SIEM Integration Add-on (https://splunkbase.splunk.com/app/4647/)
dispatch.earliest_time = -17m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_sophos` type="Event::Endpoint::NotProtected" \
| stats count, latest(_time) as _time, values(src_ip) as src_ip, values(suser) as user by host, dhost | sort -count \
| `cs_human_readable_time_format(_time, event_time)` \
| `cs_sophos_endpoint_not_protected_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Sophos
action.summary_index.alert_name = Sophos - Endpoint Not Protected by Sophos


[Sophos - Sophos RealTime Protection Disabled]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 2,17,32,47 * * * *
description = This alert will trigger when RealTime Protection is disabled on a Sophos endpoint. \
\
Data Collection - Sophos Central SIEM Integration Add-on (https://splunkbase.splunk.com/app/4647/) \
\
A false positive may appear when an administrator might have intentionally disabled RealTime Protection for Sophos. 
dispatch.earliest_time = -17m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_sophos` type="Event::Endpoint::SavDisabled" \
| stats count, latest(_time) as _time, values(src_ip) as src_ip, values(suser) as user by host, dhost | sort -count \
| `cs_human_readable_time_format(_time, event_time)` \
| `cs_sophos_realtime_protection_disabled_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Sophos
action.summary_index.alert_name = Sophos - Sophos RealTime Protection Disabled


[Sophos - Sophos Service is not Running]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 7,22,37,52 * * * *
description = This alet will trigger when a Sophos endpoint service is no longer running. \
\
Data Collection - Sophos Central SIEM Integration Add-on (https://splunkbase.splunk.com/app/4647/) \
\
A false positive may appear when an administrator might have manually stopped Sophos on an endpoint.
dispatch.earliest_time = -17m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_sophos` type="Event::Endpoint::ServiceNotRunning" \
| stats count, latest(_time) as _time, values(src_ip) as src_ip, values(suser) as user by host, dhost | sort -count \
| `cs_human_readable_time_format(_time, event_time)` \
| `cs_sophos_service_not_running_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Sophos
action.summary_index.alert_name = Sophos - Sophos Service is not Running


[Sophos - Failed to clean up threat by Sophos]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 2,17,32,47 * * * *
description = This alert will trigger when a Sophos endpoint fails to clean-up a known threat. \
\
Data Collection - Sophos Central SIEM Integration Add-on (https://splunkbase.splunk.com/app/4647/)
dispatch.earliest_time = -17m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_sophos` type IN ("Event::Endpoint::Threat::CleanupFailed", "Event::Endpoint::CoreCleanFailed", "Event::Endpoint::CoreHmpaCleanFailed", "Event::Endpoint::CoreSystemCleanFailed") \
| stats count, latest(_time) as _time, values(name) as threat, values(src_ip) as src_ip, values(suser) as user by host, dhost | sort -count \
| `cs_human_readable_time_format(_time, event_time)` \
| `cs_sophos_failed_to_cleanup_threat_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Sophos
action.summary_index.alert_name = Sophos - Failed to clean up threat by Sophos



# ======================
# Windows Defender
# ======================
[Windows Defender - Endpoint Not Protected by Windows Defender]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 7,22,37,52 * * * *
description = This alert notifies users when a Windows Defender endpoint is unprotected. \
\
Data Collection - Windows Defender Add-on (https://splunkbase.splunk.com/app/3734/) - WinEventLog://Microsoft-Windows-Windows Defender/Operational stanza
dispatch.earliest_time = -17m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_windows_defender` EventCode IN (2042, 5008, 5012) | dedup host \
| eval EventCodeDescription=case(EventCode=2042, "The antimalware engine no longer supports this operating system, and is no longer protecting your system from malware.", EventCode=5012, "Scanning for viruses is disabled.", EventCode=5008, "The antimalware engine encountered an error and failed.") \
| table _time, host, EventCode, EventCodeDescription \
| `cs_human_readable_time_format(_time, event_time)` \
| `cs_windows_defender_endpoint_not_protected`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Windows Defender
action.summary_index.alert_name = Windows Defender - Endpoint Not Protected by Windows Defender


[Windows Defender - Windows Defender RealTime Protection Disabled or Failed]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 2,17,32,47 * * * *
description = This alert notifies users when Windows Defender RealTime Protection has failed or been disabled. \
\
Data Collection - Windows Defender Add-on (https://splunkbase.splunk.com/app/3734/) - WinEventLog://Microsoft-Windows-Windows Defender/Operational stanza
dispatch.earliest_time = -17m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_windows_defender` (EventCode IN (5001, 3002) OR (EventCode=1151 AND RTP_state!="Enabled")) | dedup host \
| eval EventCodeDescription=case(EventCode=5001, "Real-time protection is disabled.", EventCode=1151, "Endpoint Protection client health report shows non enabled status for real-time protection.", EventCode=3002, "Real-time protection encountered an error and failed.") \
| eval RealTimeProtectionStatus=case(EventCode=5001, "Disabled", EventCode=1151, RTP_state, EventCode=3002, "Failed") \
| table _time, host, EventCode, EventCodeDescription, RealTimeProtectionStatus \
| `cs_human_readable_time_format(_time, event_time)` \
| `cs_windows_defender_realtime_protection_disabled_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Windows Defender
action.summary_index.alert_name = Windows Defender - Windows Defender RealTime Protection Disabled or Failed



# ======================
# CrowdStrike
# ======================
[CrowdStrike - Suspicious Activity or Malware Detected by CrowdStrike]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 2,17,32,47 * * * *
description = This alert notifies users when CrowdStrike detects a suspicios activity or malware. \
\
Data Collection - CrowdStrike Event Stream Add-on (https://splunkbase.splunk.com/app/5082/)
dispatch.earliest_time = -17m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_crowdstrike_eventstream` "metadata.eventType"=DetectionSummaryEvent action="allowed" \
| table _time, event.ComputerName, event.LocalIP, event.UserName, event.DetectDescription, event.DetectName, event.CommandLine, event.MD5String, event.SHA256String, event.ProcessId, event.PatternDispositionDescription, event.ParentCommandLine, event.Objective, event.DetectId, event.FalconHostLink, event.SeverityName, event.Tactic, event.Technique, event.ProcessStartTime, event.ProcessEndTime \
| rename event.* as * | `cs_human_readable_time_format(ProcessStartTime)` | `cs_human_readable_time_format(ProcessEndTime)` \
| `cs_human_readable_time_format(_time, event_time)` \
| `cs_crowdstrike_malware_detected_alert_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = CrowdStrike
action.summary_index.alert_name = CrowdStrike - Suspicious Activity or Malware Detected by CrowdStrike



# ======================
# Splunk Admin
# ======================
[Splunk Admin - Missing Data in the Index]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 5
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 59 * * * *
description = Generates the indexes asset lookup (cs_indexes.csv) and also alerts when there is missing data in any of the indexes in last 60 minutes. \
\
Data Collection - It uses the index=* and do not require specific data collection.
dispatch.earliest_time = 0
dispatch.latest_time = 
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats max(_indextime) as last_event, dc(sourcetype) as no_sourcetypes, dc(host) as no_hosts where `cs_all_indexes`  _index_earliest=-60m@m _index_latest=now by index \
| inputlookup append=true cs_indexes.csv \
| stats max(last_event) as last_event, last(no_sourcetypes) as no_sourcetypes, last(no_hosts) as no_hosts, last(sourcetypes) as sourcetypes, last(hosts) as hosts by index \
| eval status = if(last_event < (now() - 3600), "Missing", "Active") | eval status=if(status="Active" AND no_sourcetypes<sourcetypes, "Missing Sourcetypes", status) | eval status=if(status="Active" AND no_hosts<hosts, "Missing Hosts", status) \
| eval sourcetypes=no_sourcetypes, hosts=no_hosts \
| fields - no_sourcetypes, no_hosts \
| appendpipe [| outputlookup cs_indexes.csv | where index="DO-NOT-RETURN-ANYRESULTS"] \
| where status="Missing" \
| `cs_human_readable_time_format(last_event)` \
| `cs_splunk_admin_missing_indexes_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Splunk Admin
action.summary_index.alert_name = Splunk Admin - Missing Data in the Index


[Splunk Admin - Missing Forwarder]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 5
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 59 * * * *
description = Generates the forwarder asset lookup (cs_forwarders.csv) and also alerts when there is missing forwarder (based on _internal index data) in last 1 hour. \
\
Data Collection - It uses the index=_internal and do not require specific data collection. But if the environment do not have access to _internal index might break this alert.
dispatch.earliest_time = -62m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = (index=_internal sourcetype=splunkd (connectionType=cooked OR connectionType=cookedSSL) fwdType=* group=tcpin_connections ) \
| stats values(fwdType) as forwarder_type, latest(version) as version, values(arch) as arch, values(os) as os, max(_time) as last_connected, sum(kb) as new_sum_kb, avg(tcp_KBps) as new_avg_tcp_kbps, avg(tcp_eps) as new_avg_tcp_eps by  hostname \
| inputlookup append=true cs_forwarders.csv \
| stats values(forwarder_type) as forwarder_type, max(version) as version, values(arch) as arch, values(os) as os, max(last_connected) as last_connected, values(new_sum_kb) as sum_kb, values(new_avg_tcp_kbps) as avg_tcp_kbps, values(new_avg_tcp_eps) as avg_tcp_eps by hostname \
| addinfo | eval status = if(last_connected < (info_max_time - 3600), "Missing", "Active") \
| appendpipe [| outputlookup cs_forwarders.csv | where hostname="DO-NOT-RETURN-ANYRESULTS"] \
| where status="Missing" \
| fields -  sum_kb, avg_tcp_kbps, avg_tcp_eps, info_max_time, info_min_time, info_search_time, info_sid \
| `cs_human_readable_time_format(last_connected)` \
| `cs_splunk_admin_missing_forwarders_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Splunk Admin
action.summary_index.alert_name = Splunk Admin - Missing Forwarder


# =======================
# Device Master Table
# =======================
# Report
[Device Master Table Gen]
disabled = 0
enableSched = 1
alert.track = 0
cron_schedule = 0 1,5,9,13,17,21 * * *
description = This report update device master table on every 4 hours. \
\
Data Used - Lansweeper, Qualys, Tenable, Sophos, Crowdstrike, Windows Defender
dispatch.earliest_time = -5h@m
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | inputlookup cs_device_master_table \
\
| append [search `cs_lansweeper` | eval id=coalesce(AssetID,id)| dedup id  | rename id as lansweeper_id, site_name as Site, AssetName as Name, AssetTypename as AssetType, Statename as AssetState, Userdomain as Domain, AssetGroup as GroupName, IPAddress as IPAddress, Mac as lansweeper_mac_address, OScode as OSVersion, Username as lansweeper_user, BuildNumber as BuildNumber, version as AssetVersion \
| rename host as lansweeper_collected_by, _time as lansweeper_last_event, IPAddress as ip , OS as lansweeper_OS| eval host=lower(Name) \
| table lansweeper_last_event, lansweeper_collected_by, host, ip, lansweeper_id, Site, AssetType, AssetState, Domain, GroupName, lansweeper_mac_address, OSVersion, BuildNumber, AssetVersion, lansweeper_user,lansweeper_OS, Description, IPLocation,FQDN ] \
\
| append [search `cs_qualys_hostsummary` | dedup HOST_ID \
| rename HOST_ID as qualys_host_id, _time as qualys_last_event, host as qualys_collected_by, IP as ip, OS as QUALYS_OS \
| table qualys_last_event, qualys_collected_by qualys_host_id, ip, DNS, QUALYS_OS, NETWORK_ID, TRACKING_METHOD, ACTIVE*, CONFIRMED*, FIXED*, INFO*, LAST_*, NEW*, POTENTIAL*, RE_OPENED*, SEVERITY_*, TOTAL_VULNS] \
\
| append [| inputlookup cs_tenable_vuln \
| stats max(_time) as _time, count, count(eval(vul_state="open" OR vul_state="reopened")) as active, count(eval(vul_state="fixed")) as fixed by ip, host, vul_severity \
| stats max(_time) as _time, sum(count) as total_vuln, sum(eval(if(vul_severity="informational", count, 0))) as info_vuln, sum(eval(if(vul_severity="low", count, 0))) as low_vuln, sum(eval(if(vul_severity="medium", count, 0))) as medium_vuln, sum(eval(if(vul_severity="high", count, 0))) as high_vuln, sum(eval(if(vul_severity="critical", count, 0))) as critical_vuln, sum(active) as active_vuln, sum(eval(if(vul_severity="informational", active, 0))) as info_active_vuln, sum(eval(if(vul_severity="low", active, 0))) as low_active_vuln, sum(eval(if(vul_severity="medium", active, 0))) as medium_active_vuln, sum(eval(if(vul_severity="high", active, 0))) as high_active_vuln, sum(eval(if(vul_severity="critical", active, 0))) as critical_active_vuln, sum(fixed) as fixed_vuln, sum(eval(if(vul_severity="informational", fixed, 0))) as info_fixed_vuln, sum(eval(if(vul_severity="low", fixed, 0))) as low_fixed_vuln, sum(eval(if(vul_severity="medium", fixed, 0))) as medium_fixed_vuln, sum(eval(if(vul_severity="high", fixed, 0))) as high_fixed_vuln, sum(eval(if(vul_severity="critical", fixed, 0))) as critical_fixed_vuln by ip, host \
| append [| inputlookup cs_tenable_assets] \
| stats values(*) as *, max(_time) as _time by ip, host \
| rename _time as tenable_last_event, created_at as tenable_created_at, first_seen as tenable_first_seen, last_seen as tenable_last_seen \
| table tenable_last_event, tenable_collected_by, ip, host, tenable_all_ips, tenable_mac_address, tenable_os, tenable_state, has_agent, has_plugin_results, tenable_network_name, tenable_fqdn, tenable_netbios, total_vuln, info_vuln, low_vuln, medium_vuln, high_vuln, critical_vuln, active_vuln, info_active_vuln, low_active_vuln, medium_active_vuln, high_active_vuln, critical_active_vuln, fixed_vuln, info_fixed_vuln, low_fixed_vuln, medium_fixed_vuln, high_fixed_vuln, critical_fixed_vuln, tenable_last_seen_vuln, last_authenticated_scan_date, last_licensed_scan_date, tenable_created_at, first_scan_time, tenable_first_seen] \
\
| append [search `cs_sophos` | dedup dhost | rename suser as sophos_user, customer_id as sophos_customer_id \
| rename host as sophos_collected_by, _time as sophos_last_event, "source_info.ip" as ip | eval host=lower(dhost) \
| table sophos_last_event, sophos_collected_by, host, ip, sophos_customer_id, sophos_user \
| append [search `cs_sophos` type IN ("Event::Endpoint::ServiceNotRunning", "Event::Endpoint::ServiceRestored", "Event::Endpoint::SavDisabled", "Event::Endpoint::SavEnabled") \
| stats latest(_time) as _time by dhost, type \
| eval ServiceNotRunning = if(type="Event::Endpoint::ServiceNotRunning", _time, null()), ServiceRestored = if(type="Event::Endpoint::ServiceRestored", _time, null()), SavDisabled = if(type="Event::Endpoint::SavDisabled", _time, null()), SavEnabled = if(type="Event::Endpoint::SavEnabled", _time, null()) \
| stats latest(*) as * by dhost \
| eval sophos_status=case(ServiceNotRunning>ServiceRestored, "Service not Running", SavDisabled>SavEnabled, "RTP Disabled", 1==1, "RTP Enabled") | fields dhost, sophos_status | eval host=lower(dhost)] \
| stats values(*) as * by host] \
\
| append [search `cs_crowdstrike_eventstream` \
| rename "metadata.customerIDString" as crowdstrike_customer_id, "event.MACAddress" as crowdstrike_mac_address \
| eval crowdstrike_user=coalesce('event.UserId', 'event.UserName'), ip=coalesce('event.UserIp', 'event.LocalIP'), crowdstrike_host=coalesce('event.ComputerName', 'event.HostnameField') \
| eventstats values(crowdstrike_host) AS newhostfield by ip \
| eventstats values(ip) AS newipfield by crowdstrike_host \
| eval reallynewipfield = coalesce(ip,newipfield), reallynewhostfield = coalesce(crowdstrike_host,newhostfield) \
| fillnull reallynewipfield, reallynewhostfield value=" - " \
| where !(reallynewipfield=" - " AND reallynewhostfield=" - ") \
| rename reallynewipfield as ip, reallynewhostfield as crowdstrike_host | fields - newipfield, newhostfield \
| stats latest(_time) as crowdstrike_last_event, latest(crowdstrike_user) as crowdstrike_user, latest(crowdstrike_mac_address) as crowdstrike_mac_address, latest(crowdstrike_customer_id) as crowdstrike_customer_id by crowdstrike_host, ip, host \
| rename host as crowdstrike_collected_by \
| eval host=lower(crowdstrike_host) \
| table crowdstrike_last_event, crowdstrike_collected_by, crowdstrike_customer_id, host, ip, crowdstrike_mac_address, crowdstrike_user, *] \
\
| append [search `cs_windows_defender` EventCode=1151 | dedup host \
| table _time, host, RTP_state, Platform_version, Engine_version, AVSignature_version, BM_state, IOAV_state, OA_state, Last_full_scan_start_time, Last_full_scan_end_time, Last_quick_scan_start_time, Last_quick_scan_end_time \
| eval Last_full_scan_start_time=if(Last_full_scan_start_time="1/1/1601 12:00:00 AM", "-", Last_full_scan_start_time), Last_full_scan_end_time=if(Last_full_scan_end_time="1/1/1601 12:00:00 AM", "-", Last_full_scan_end_time),  Last_quick_scan_start_time=if(Last_quick_scan_start_time="1/1/1601 12:00:00 AM", "-", Last_quick_scan_start_time), Last_quick_scan_end_time=if(Last_quick_scan_end_time="1/1/1601 12:00:00 AM", "-", Last_quick_scan_end_time) \
| rename _time as defender_last_event | eval host=lower(host)] \
\
| eventstats values(host) AS newhostfield by ip \
| eventstats values(ip) AS newipfield by host \
| eval reallynewipfield = coalesce(ip,newipfield), reallynewhostfield = coalesce(host,newhostfield) \
| fillnull reallynewipfield, reallynewhostfield value=" - " \
| rename reallynewipfield as ip, reallynewhostfield as host | fields - newipfield, newhostfield \
| stats last(*) as * by host, ip \
\
| outputlookup cs_device_master_table

# CleanUp
[Device Master Table CleanUp]
disabled = 0
enableSched = 0
alert.track = 0
description = This report is only for cleaning up Device Master Table. Read the App's documentation for more information.
dispatch.earliest_time = 0
dispatch.latest_time = 
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | inputlookup cs_device_master_table | eval last60days=relative_time(now(), "$lastNdays$") \
\
| eval lansweeper_collected_by=if(lansweeper_last_event<last60days, null(), lansweeper_collected_by), lansweeper_id=if(lansweeper_last_event<last60days, null(), lansweeper_id), Site=if(lansweeper_last_event<last60days, null(), Site), AssetType=if(lansweeper_last_event<last60days, null(), AssetType), AssetState=if(lansweeper_last_event<last60days, null(), AssetState), Domain=if(lansweeper_last_event<last60days, null(), Domain), GroupName=if(lansweeper_last_event<last60days, null(), GroupName), lansweeper_mac_address=if(lansweeper_last_event<last60days, null(), lansweeper_mac_address), OSVersion=if(lansweeper_last_event<last60days, null(), OSVersion), BuildNumber=if(lansweeper_last_event<last60days, null(), BuildNumber), AssetVersion=if(lansweeper_last_event<last60days, null(), AssetVersion), lansweeper_user=if(lansweeper_last_event<last60days, null(), lansweeper_user), lansweeper_OS=if(lansweeper_last_event<last60days, null(), lansweeper_OS) , Description=if(lansweeper_last_event<last60days, null(), Description) , IPLocation=if(lansweeper_last_event<last60days, null(), IPLocation) , FQDN=if(lansweeper_last_event<last60days, null(), FQDN)\
| eval lansweeper_last_event=if(lansweeper_last_event<last60days, null(), lansweeper_last_event) \
\
| eval qualys_collected_by=if(qualys_last_event<last60days, null(), qualys_collected_by), qualys_host_id=if(qualys_last_event<last60days, null(), qualys_host_id), DNS=if(qualys_last_event<last60days, null(), DNS), NETWORK_ID=if(qualys_last_event<last60days, null(), NETWORK_ID), QUALYS_OS=if(qualys_last_event<last60days, null(), QUALYS_OS), TOTAL_VULNS=if(qualys_last_event<last60days, null(), TOTAL_VULNS), TRACKING_METHOD=if(qualys_last_event<last60days, null(), TRACKING_METHOD), LAST_SCAN_DATETIME=if(qualys_last_event<last60days, null(), LAST_SCAN_DATETIME), LAST_VM_SCANNED_DATE=if(qualys_last_event<last60days, null(), LAST_VM_SCANNED_DATE), LAST_VM_SCANNED_DURATION=if(qualys_last_event<last60days, null(), LAST_VM_SCANNED_DURATION), ACTIVE=if(qualys_last_event<last60days, null(), ACTIVE), ACTIVE_SEVERITY_1=if(qualys_last_event<last60days, null(), ACTIVE_SEVERITY_1), ACTIVE_SEVERITY_2=if(qualys_last_event<last60days, null(), ACTIVE_SEVERITY_2), ACTIVE_SEVERITY_3=if(qualys_last_event<last60days, null(), ACTIVE_SEVERITY_3), ACTIVE_SEVERITY_4=if(qualys_last_event<last60days, null(), ACTIVE_SEVERITY_4), ACTIVE_SEVERITY_5=if(qualys_last_event<last60days, null(), ACTIVE_SEVERITY_5), CONFIRMED=if(qualys_last_event<last60days, null(), qualys), CONFIRMED=if(qualys_last_event<last60days, null(), CONFIRMED), CONFIRMED_ACTIVE=if(qualys_last_event<last60days, null(), CONFIRMED_ACTIVE), CONFIRMED_FIXED=if(qualys_last_event<last60days, null(), CONFIRMED_FIXED), CONFIRMED_NEW=if(qualys_last_event<last60days, null(), CONFIRMED_NEW), CONFIRMED_RE_OPENED=if(qualys_last_event<last60days, null(), CONFIRMED_RE_OPENED), CONFIRMED_SEVERITY_1=if(qualys_last_event<last60days, null(), CONFIRMED_SEVERITY_1), CONFIRMED_SEVERITY_2=if(qualys_last_event<last60days, null(), CONFIRMED_SEVERITY_2), CONFIRMED_SEVERITY_3=if(qualys_last_event<last60days, null(), CONFIRMED_SEVERITY_3), CONFIRMED_SEVERITY_4=if(qualys_last_event<last60days, null(), CONFIRMED_SEVERITY_4), CONFIRMED_SEVERITY_5=if(qualys_last_event<last60days, null(), CONFIRMED_SEVERITY_5), FIXED=if(qualys_last_event<last60days, null(), FIXED), FIXED_SEVERITY_1=if(qualys_last_event<last60days, null(), FIXED_SEVERITY_1), FIXED_SEVERITY_2=if(qualys_last_event<last60days, null(), FIXED_SEVERITY_2), FIXED_SEVERITY_3=if(qualys_last_event<last60days, null(), FIXED_SEVERITY_3), FIXED_SEVERITY_4=if(qualys_last_event<last60days, null(), FIXED_SEVERITY_4), FIXED_SEVERITY_5=if(qualys_last_event<last60days, null(), FIXED_SEVERITY_5), INFO=if(qualys_last_event<last60days, null(), INFO), INFO_SEVERITY_1=if(qualys_last_event<last60days, null(), INFO_SEVERITY_1), INFO_SEVERITY_2=if(qualys_last_event<last60days, null(), INFO_SEVERITY_2), INFO_SEVERITY_3=if(qualys_last_event<last60days, null(), INFO_SEVERITY_3), INFO_SEVERITY_4=if(qualys_last_event<last60days, null(), INFO_SEVERITY_4), INFO_SEVERITY_5=if(qualys_last_event<last60days, null(), INFO_SEVERITY_5), NEW=if(qualys_last_event<last60days, null(), NEW), NEW_SEVERITY_1=if(qualys_last_event<last60days, null(), NEW_SEVERITY_1), NEW_SEVERITY_2=if(qualys_last_event<last60days, null(), NEW_SEVERITY_2), NEW_SEVERITY_3=if(qualys_last_event<last60days, null(), NEW_SEVERITY_3), NEW_SEVERITY_4=if(qualys_last_event<last60days, null(), NEW_SEVERITY_4), NEW_SEVERITY_5=if(qualys_last_event<last60days, null(), NEW_SEVERITY_5), POTENTIAL=if(qualys_last_event<last60days, null(), POTENTIAL), POTENTIAL_ACTIVE=if(qualys_last_event<last60days, null(), POTENTIAL_ACTIVE), POTENTIAL_FIXED=if(qualys_last_event<last60days, null(), POTENTIAL_FIXED), POTENTIAL_NEW=if(qualys_last_event<last60days, null(), POTENTIAL_NEW), POTENTIAL_RE_OPENED=if(qualys_last_event<last60days, null(), POTENTIAL_RE_OPENED), POTENTIAL_SEVERITY_1=if(qualys_last_event<last60days, null(), POTENTIAL_SEVERITY_1), POTENTIAL_SEVERITY_2=if(qualys_last_event<last60days, null(), POTENTIAL_SEVERITY_2), POTENTIAL_SEVERITY_3=if(qualys_last_event<last60days, null(), POTENTIAL_SEVERITY_3), POTENTIAL_SEVERITY_4=if(qualys_last_event<last60days, null(), POTENTIAL_SEVERITY_4), POTENTIAL_SEVERITY_5=if(qualys_last_event<last60days, null(), POTENTIAL_SEVERITY_5), RE_OPENED=if(qualys_last_event<last60days, null(), RE_OPENED), RE_OPENED_SEVERITY_1=if(qualys_last_event<last60days, null(), RE_OPENED_SEVERITY_1), RE_OPENED_SEVERITY_2=if(qualys_last_event<last60days, null(), RE_OPENED_SEVERITY_2), RE_OPENED_SEVERITY_3=if(qualys_last_event<last60days, null(), RE_OPENED_SEVERITY_3), RE_OPENED_SEVERITY_4=if(qualys_last_event<last60days, null(), RE_OPENED_SEVERITY_4), RE_OPENED_SEVERITY_5=if(qualys_last_event<last60days, null(), RE_OPENED_SEVERITY_5), SEVERITY_1=if(qualys_last_event<last60days, null(), SEVERITY_1), SEVERITY_2=if(qualys_last_event<last60days, null(), SEVERITY_2), SEVERITY_3=if(qualys_last_event<last60days, null(), SEVERITY_3), SEVERITY_4=if(qualys_last_event<last60days, null(), SEVERITY_4), SEVERITY_5=if(qualys_last_event<last60days, null(), SEVERITY_5) \
| eval qualys_last_event=if(qualys_last_event<last60days, null(), qualys_last_event) \
\
| eval tenable_collected_by=if(tenable_last_event<last60days, null(), tenable_collected_by), tenable_all_ips=if(tenable_last_event<last60days, null(), tenable_all_ips), tenable_mac_address=if(tenable_last_event<last60days, null(), tenable_mac_address), tenable_os=if(tenable_last_event<last60days, null(), tenable_os), tenable_state=if(tenable_last_event<last60days, null(), tenable_state), has_agent=if(tenable_last_event<last60days, null(), has_agent), has_plugin_results=if(tenable_last_event<last60days, null(), has_plugin_results), tenable_network_name=if(tenable_last_event<last60days, null(), tenable_network_name), tenable_fqdn=if(tenable_last_event<last60days, null(), tenable_fqdn), tenable_netbios=if(tenable_last_event<last60days, null(), tenable_netbios), total_vuln=if(tenable_last_event<last60days, null(), total_vuln), info=if(tenable_last_event<last60days, null(), info), low=if(tenable_last_event<last60days, null(), low), medium=if(tenable_last_event<last60days, null(), medium), high=if(tenable_last_event<last60days, null(), high), critical=if(tenable_last_event<last60days, null(), critical), active_vuln=if(tenable_last_event<last60days, null(), active_vuln), info_active=if(tenable_last_event<last60days, null(), info_active), low_active=if(tenable_last_event<last60days, null(), low_active), medium_active=if(tenable_last_event<last60days, null(), medium_active), high_active=if(tenable_last_event<last60days, null(), high_active), critical_active=if(tenable_last_event<last60days, null(), critical_active), fixed_vuln=if(tenable_last_event<last60days, null(), fixed_vuln), info_fixed=if(tenable_last_event<last60days, null(), info_fixed), low_fixed=if(tenable_last_event<last60days, null(), low_fixed), medium_fixed=if(tenable_last_event<last60days, null(), medium_fixed), high_fixed=if(tenable_last_event<last60days, null(), high_fixed), critical_fixed=if(tenable_last_event<last60days, null(), critical_fixed), tenable_last_seen=if(tenable_last_event<last60days, null(), tenable_last_seen), last_authenticated_scan_date=if(tenable_last_event<last60days, null(), last_authenticated_scan_date), last_licensed_scan_date=if(tenable_last_event<last60days, null(), last_licensed_scan_date), tenable_created_at=if(tenable_last_event<last60days, null(), tenable_created_at), first_scan_time=if(tenable_last_event<last60days, null(), first_scan_time), tenable_first_seen=if(tenable_last_event<last60days, null(), tenable_first_seen) \
| eval tenable_last_event=if(tenable_last_event<last60days, null(), tenable_last_event) \
\
| eval RTP_state=if(defender_last_event<last60days, null(), RTP_state), Platform_version=if(defender_last_event<last60days, null(), Platform_version), Engine_version=if(defender_last_event<last60days, null(), Engine_version), AVSignature_version=if(defender_last_event<last60days, null(), AVSignature_version), BM_state=if(defender_last_event<last60days, null(), BM_state), IOAV_state=if(defender_last_event<last60days, null(), IOAV_state), OA_state=if(defender_last_event<last60days, null(), OA_state), Last_full_scan_start_time=if(defender_last_event<last60days, null(), Last_full_scan_start_time), Last_full_scan_end_time=if(defender_last_event<last60days, null(), Last_full_scan_end_time), Last_quick_scan_start_time=if(defender_last_event<last60days, null(), Last_quick_scan_start_time), Last_quick_scan_end_time=if(defender_last_event<last60days, null(), Last_quick_scan_end_time) \
| eval defender_last_event=if(defender_last_event<last60days, null(), defender_last_event) \
\
| eval sophos_collected_by=if(sophos_last_event<last60days, null(), sophos_collected_by), sophos_customer_id=if(sophos_last_event<last60days, null(), sophos_customer_id), sophos_status=if(sophos_last_event<last60days, null(), sophos_status), sophos_user=if(sophos_last_event<last60days, null(), sophos_user) \
| eval sophos_last_event=if(sophos_last_event<last60days, null(), sophos_last_event) \
\
| eval crowdstrike_collected_by=if(crowdstrike_last_event<last60days, null(), crowdstrike_collected_by), crowdstrike_customer_id=if(crowdstrike_last_event<last60days, null(), crowdstrike_customer_id), crowdstrike_mac_address=if(crowdstrike_last_event<last60days, null(), crowdstrike_mac_address), crowdstrike_user=if(crowdstrike_last_event<last60days, null(), crowdstrike_user) \
| eval crowdstrike_last_event=if(crowdstrike_last_event<last60days, null(), crowdstrike_last_event) \
\
| fields - last60days \
| search (lansweeper_last_event=* OR qualys_last_event=* OR tenable_last_event=* OR defender_last_event=* OR sophos_last_event=* OR crowdstrike_last_event=*) \
| outputlookup cs_device_master_table

# ========
# Tenable
# ========
# Report
[Tenable Assets Lookup Gen]
disabled = 1
enableSched = 1
alert.track = 0
cron_schedule = 29 * * * *
description = This report generate tenable assets lookup. \
\
Data Collection - The tenable data are necessary to collect the vulnerability scan results and host summaries via the Tenable Add-On for Splunk(https://splunkbase.splunk.com/app/4060/).
dispatch.earliest_time = -62m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_tenable_assets` | eval ip=mvappend(ipv4s, ipv6s), tenable_all_ips=mvjoin(ip, ", ") | mvexpand ip | eval hostnames=coalesce(hostnames, fqdns) | fillnull hostnames value="-" | mvexpand hostnames | dedup ip, hostnames \
| rename host as tenable_collected_by, network_name as tenable_network_name, state as tenable_state | eval host=lower(hostnames) \
| eval tenable_mac_address=mvjoin(mac_addresses, ", "), tenable_fqdn=mvjoin(fqdns, ", "), tenable_netbios=mvjoin(netbios_names, ", "), tenable_os=mvjoin(operating_systems, ", ") \
| table _time, tenable_collected_by, ip, host, tenable_all_ips, tenable_mac_address, tenable_fqdn, tenable_netbios, tenable_os, tenable_state, tenable_network_name, created_at, first_scan_time, first_seen, has_agent, has_plugin_results, last_authenticated_scan_date, last_licensed_scan_date, last_seen \
| append [| inputlookup cs_tenable_assets] \
| dedup ip, host sortby -_time \
| outputlookup cs_tenable_assets

[Tenable Vuln Lookup Gen]
disabled = 1
enableSched = 1
alert.track = 0
cron_schedule = 59 * * * *
description = This report generate tenable vulnerabilities lookup. \
\
Data Collection - The tenable data are necessary to collect the vulnerability scan results and host summaries via the Tenable Add-On for Splunk(https://splunkbase.splunk.com/app/4060/).
dispatch.earliest_time = -62m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = `cs_tenable_vuln` | rename asset_fqdn as host | fillnull host value="-" | eval host=if(host="null", "-", lower(host)) | eval ipv4=if(ipv4="null", null(), ipv4) | eval ipv6=if(ipv6="null", null(), ipv6) | eval ip=mvappend(ipv4, ipv6) | mvexpand ip | dedup ip, host, "plugin.id" \
| rename "plugin.id" as vul_id, "plugin.description" as vul_description, "plugin.family" as vul_family, "plugin.has_patch" as vul_has_patch, "plugin.in_the_news" as vul_in_the_news, "plugin.name" as vul_name, "plugin.risk_factor" as vul_risk_factor, "plugin.synopsis" as vul_synopsis, "plugin.type" as vul_type, "plugin.version" as vul_version, "port.port" as vul_port, "port.protocol" as vul_protocol, severity as vul_severity, severity_id as vul_severity_id, state as vul_state \
| eval vul_cpe=mvjoin('plugin.cpe{}', " ,") \
| table _time, ip, host, vul_id, vul_name, vul_description, vul_severity, vul_severity_id, vul_state, last_fixed, last_found, vul_cpe, vul_family, vul_has_patch, vul_in_the_news, vul_risk_factor, vul_synopsis, vul_type, vul_version, vul_protocol, vul_port \
| append [| inputlookup cs_tenable_vuln] \
| dedup ip, host, vul_id sortby -_time \
| outputlookup cs_tenable_vuln

# ===============
# Authentication
# ===============
[Authentication - Bruteforce Attempt for a User]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 29 * * * *
description = A bruteforce attempt (more than 100 failures in an hour) for a perticular username. \
\
Data Collection - Any authentication data mapped with Authentication data model.
dispatch.earliest_time = -62m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats `cs_summariesonly_authentication` count, min(_time) as firstTime, max(_time) as lastTime, values(Authentication.signature) as signature, values(Authentication.src) as src from datamodel=Authentication where `cs_authentication_indexes` Authentication.app!=OktaIM2:log Authentication.action="failure" `cs_authentication_app_filter` by Authentication.app, Authentication.user \
| where count > `cs_authentication_bruteforce_attempt_limit` \
| `drop_dm_object_name(Authentication)` \
| `cs_human_readable_time_format(firstTime)` \
| `cs_human_readable_time_format(lastTime)` \
| eval reasons=mvjoin(signature, ", ") | fields - signature | eval sources=mvjoin(src, ", ") | fields - src \
| `cs_authentication_bruteforce_attempt_for_user_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Authentication
action.summary_index.alert_name = Authentication - Bruteforce Attempt for a User


[Authentication - Bruteforce Attempt from a Source]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 29 * * * *
description = A bruteforce attempt (more than 100 failures in an hour) from a perticular source. \
\
Data Collection - Any authentication data mapped with Authentication data model.
dispatch.earliest_time = -62m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats `cs_summariesonly_authentication` count, min(_time) as firstTime, max(_time) as lastTime, values(Authentication.signature) as signature, values(Authentication.user) as user from datamodel=Authentication where  `cs_authentication_indexes` Authentication.app!=OktaIM2:log Authentication.action="failure" `cs_authentication_app_filter` by Authentication.app, Authentication.src \
| where count > `cs_authentication_bruteforce_attempt_limit` \
| `drop_dm_object_name(Authentication)` \
| `cs_human_readable_time_format(firstTime)` \
| `cs_human_readable_time_format(lastTime)` \
| eval reasons=mvjoin(signature, ", ") | fields - signature | eval users=mvjoin(user, ", ") | fields - user \
| `cs_authentication_bruteforce_attempt_from_source_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Authentication
action.summary_index.alert_name = Authentication - Bruteforce Attempt from a Source


[Authentication - Excessive Failed VPN Logins for a User]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 59 * * * *
description = A excessive login failures (more than 20 failures in an hour) for VPN for a perticular username. \
\
Data Collection - VPN data mapped with authentication data-model and has dest=vpn_auth.
dispatch.earliest_time = -62m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats `cs_summariesonly_authentication` count, min(_time) as firstTime, max(_time) as lastTime, values(Authentication.src) as src from datamodel=Authentication where Authentication.dest="vpn_auth" AND `cs_vpn_indexes` AND Authentication.action="failure" by index, Authentication.app, Authentication.user \
| where count > `cs_authentication_excessive_vpn_login_failure_limit` \
| `drop_dm_object_name(Authentication)` \
| `cs_human_readable_time_format(firstTime)` \
| `cs_human_readable_time_format(lastTime)` \
| eval reasons=mvjoin(signature, ", ") | fields - signature | eval sources=mvjoin(src, ", ") | fields - src \
| `cs_authentication_excessive_vpn_login_failure_for_user_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Authentication
action.summary_index.alert_name = Authentication - Excessive Failed VPN Logins for a User


[Authentication - Excessive Failed VPN Logins from a Source]
disabled = 1
enableSched = 1
alert.track = 1
alert.severity = 4
alert.suppress = 0
counttype = number of events
quantity = 0
relation = greater than
cron_schedule = 59 * * * *
description = A excessive login failures (more than 20 failures in an hour) for VPN from a perticular source. \
\
Data Collection - VPN data mapped with authentication data-model and has dest=vpn_auth.
dispatch.earliest_time = -62m@m
dispatch.latest_time = -2m@m
display.general.type = statistics
display.page.search.tab = statistics
display.page.search.mode = fast
request.ui_dispatch_app = cyences_app_for_splunk
request.ui_dispatch_view = search
search = | tstats `cs_summariesonly_authentication` count, min(_time) as firstTime, max(_time) as lastTime, values(Authentication.user) as user from datamodel=Authentication where Authentication.dest="vpn_auth" AND `cs_vpn_indexes` AND Authentication.action="failure" by index, Authentication.app, Authentication.src \
| where count > `cs_authentication_excessive_vpn_login_failure_limit` \
| `drop_dm_object_name(Authentication)` \
| `cs_human_readable_time_format(firstTime)` \
| `cs_human_readable_time_format(lastTime)` \
| eval reasons=mvjoin(signature, ", ") | fields - signature | eval users=mvjoin(user, ", ") | fields - user \
| `cs_authentication_excessive_vpn_login_failure_from_source_filter`
action.summary_index = 1
action.summary_index._name = cyences
action.summary_index.category = Authentication
action.summary_index.alert_name = Authentication - Excessive Failed VPN Logins from a Source
